import{Color as e,SegmentedRange as t,Settings as i,UIString as s,ObjectWrapper as r,ls as n,Throttler as o}from"../common/common.js";import{ls as a,NumberUtilities as l}from"../platform/platform.js";import{Utils as h,Widget as d,ARIAUtils as c,UIUtils as _,KeyboardShortcut as m,Tooltip as u,Fragment as g,Dialog as f,GlassPane as p}from"../ui/ui.js";import{Platform as v,InspectorFrontendHost as w}from"../host/host.js";import{Runtime as y}from"../root/root.js";import{ThemeSupport as E}from"../theme_support/theme_support.js";import{SDKModel as T,HeapProfilerModel as S,DebuggerModel as b,ResourceTreeModel as x}from"../sdk/sdk.js";import{LiveLocation as L,DebuggerWorkspaceBinding as C}from"../bindings/bindings.js";import{Workspace as P}from"../workspace/workspace.js";import*as D from"../third_party/lit-html/lit-html.js";const k=new Map;class R{constructor(){this.element=document.createElement("div"),h.appendStyle(this.element,"perf_ui/timelineGrid.css",{enableLegacyPatching:!0}),this._dividersElement=this.element.createChild("div","resources-dividers"),this._gridHeaderElement=document.createElement("div"),this._gridHeaderElement.classList.add("timeline-grid-header"),this._eventDividersElement=this._gridHeaderElement.createChild("div","resources-event-dividers"),this._dividersLabelBarElement=this._gridHeaderElement.createChild("div","resources-dividers-label-bar"),this.element.appendChild(this._gridHeaderElement)}static calculateGridOffsets(e,t){const i=e.computePosition(e.maximumBoundary());let s=i/64,r=e.boundarySpan()/s;const n=i/e.boundarySpan(),o=Math.ceil(Math.log(r)/Math.LN10);r=Math.pow(10,o),r*n>=320&&(r/=5),r*n>=128&&(r/=2);const a=Math.ceil((e.minimumBoundary()-e.zeroTime())/r)*r+e.zeroTime();let l=e.maximumBoundary();l+=64/n,s=Math.ceil((l-a)/r),r||(s=0);const h=[];for(let i=0;i<s;++i){const s=a+r*i;e.computePosition(s)<(t||0)||h.push({position:Math.floor(e.computePosition(s)),time:s})}return{offsets:h,precision:Math.max(0,-Math.floor(Math.log(1.01*r)/Math.LN10))}}static drawCanvasGrid(e,t){e.save(),e.scale(window.devicePixelRatio,window.devicePixelRatio);const i=Math.floor(e.canvas.height/window.devicePixelRatio);e.strokeStyle=E.instance().patchColorText("rgba(0, 0, 0, 0.1)",E.ColorUsage.Foreground),e.lineWidth=1,e.translate(.5,.5),e.beginPath();for(const s of t.offsets)e.moveTo(s.position,0),e.lineTo(s.position,i);e.stroke(),e.restore()}static drawCanvasHeaders(e,t,i,s,r,n){e.save(),e.scale(window.devicePixelRatio,window.devicePixelRatio);const o=Math.ceil(e.canvas.width/window.devicePixelRatio);e.beginPath(),e.fillStyle=E.instance().patchColorText("rgba(255, 255, 255, 0.5)",E.ColorUsage.Background),e.fillRect(0,0,o,r),e.fillStyle=E.instance().patchColorText("#333",E.ColorUsage.Foreground),e.textBaseline="hanging",e.font="11px "+v.fontFamily();for(const r of t.offsets){const t=i(r.time),o=e.measureText(t).width,a=r.position-o-4;(!n||n<a)&&e.fillText(t,a,s)}e.restore()}get dividersElement(){return this._dividersElement}get dividersLabelBarElement(){return this._dividersLabelBarElement}removeDividers(){this._dividersElement.removeChildren(),this._dividersLabelBarElement.removeChildren()}updateDividers(e,t){const i=R.calculateGridOffsets(e,t),s=i.offsets,r=i.precision,n=this._dividersElement.clientWidth;let o=this._dividersElement.firstChild,a=this._dividersLabelBarElement.firstChild;for(let t=0;t<s.length;++t){if(!o){o=document.createElement("div"),o.className="resources-divider",this._dividersElement.appendChild(o),a=document.createElement("div"),a.className="resources-divider";const e=document.createElement("div");e.className="resources-divider-label",k.set(a,e),a.appendChild(e),this._dividersLabelBarElement.appendChild(a)}const i=s[t].time,l=s[t].position;if(a){const t=k.get(a);t&&(t.textContent=e.formatValue(i,r))}const h=100*l/n;o.style.left=h+"%",a&&(a.style.left=h+"%"),o=o.nextSibling,a&&(a=a.nextSibling)}for(;o;){const e=o.nextSibling;if(this._dividersElement.removeChild(o),!e)break;o=e}for(;a;){const e=a.nextSibling;if(this._dividersLabelBarElement.removeChild(a),!e)break;a=e}return!0}addEventDivider(e){this._eventDividersElement.appendChild(e)}addEventDividers(e){this._gridHeaderElement.removeChild(this._eventDividersElement);for(const t of e)this._eventDividersElement.appendChild(t);this._gridHeaderElement.appendChild(this._eventDividersElement)}removeEventDividers(){this._eventDividersElement.removeChildren()}hideEventDividers(){this._eventDividersElement.classList.add("hidden")}showEventDividers(){this._eventDividersElement.classList.remove("hidden")}hideDividers(){this._dividersElement.classList.add("hidden")}showDividers(){this._dividersElement.classList.remove("hidden")}setScrollTop(e){this._dividersLabelBarElement.style.top=e+"px",this._eventDividersElement.style.top=e+"px"}}var G=Object.freeze({__proto__:null,TimelineGrid:R,Calculator:class{computePosition(e){throw new Error("Not implemented")}formatValue(e,t){throw new Error("Not implemented")}minimumBoundary(){throw new Error("Not implemented")}zeroTime(){throw new Error("Not implemented")}maximumBoundary(){throw new Error("Not implemented")}boundarySpan(){throw new Error("Not implemented")}},DividersData:undefined});class M extends d.VBox{constructor(e,t,i){super(!0),this.registerRequiredCSS("perf_ui/flameChart.css",{enableLegacyPatching:!0}),this.contentElement.classList.add("flame-chart-main-pane"),this._groupExpansionSetting=i,this._groupExpansionState=i&&i.get()||{},this._flameChartDelegate=t,this._useWebGL=y.experiments.isEnabled("timelineWebGL"),this._chartViewport=new z(this),this._chartViewport.show(this.contentElement),this._dataProvider=e,this._candyStripeCanvas=document.createElement("canvas"),this._createCandyStripePattern(),this._viewportElement=this._chartViewport.viewportElement,this._useWebGL&&(this._canvasGL=this._viewportElement.createChild("canvas","fill"),this._initWebGL()),this._canvas=this._viewportElement.createChild("canvas","fill"),this._canvas.tabIndex=0,c.setAccessibleName(this._canvas,a`Flame Chart`),c.markAsTree(this._canvas),this.setDefaultFocusedElement(this._canvas),this._canvas.classList.add("flame-chart-canvas"),this._canvas.addEventListener("mousemove",this._onMouseMove.bind(this),!1),this._canvas.addEventListener("mouseout",this._onMouseOut.bind(this),!1),this._canvas.addEventListener("click",this._onClick.bind(this),!1),this._canvas.addEventListener("keydown",this._onKeyDown.bind(this),!1),this._entryInfo=this._viewportElement.createChild("div","flame-chart-entry-info"),this._markerHighlighElement=this._viewportElement.createChild("div","flame-chart-marker-highlight-element"),this._highlightElement=this._viewportElement.createChild("div","flame-chart-highlight-element"),this._selectedElement=this._viewportElement.createChild("div","flame-chart-selected-element"),this._canvas.addEventListener("focus",(()=>{this._selectedElement.classList.remove("flame-chart-unfocused-selected-element"),this.dispatchEventToListeners(F.CanvasFocused)}),!1),this._canvas.addEventListener("blur",(()=>{this._selectedElement.classList.add("flame-chart-unfocused-selected-element")}),!1),_.installDragHandle(this._viewportElement,this._startDragging.bind(this),this._dragging.bind(this),this._endDragging.bind(this),null),this._rulerEnabled=!0,this._rangeSelectionStart=0,this._rangeSelectionEnd=0,this._barHeight=17,this._textBaseline=5,this._textPadding=5,this._markerRadius=6,this._chartViewport.setWindowTimes(e.minimumBoundary(),e.minimumBoundary()+e.totalTime()),this._headerLeftPadding=6,this._arrowSide=8,this._expansionArrowIndent=this._headerLeftPadding+this._arrowSide/2,this._headerLabelXPadding=3,this._headerLabelYPadding=2,this._highlightedMarkerIndex=-1,this._highlightedEntryIndex=-1,this._selectedEntryIndex=-1,this._rawTimelineDataLength=0,this._textWidth=new Map,this._markerPositions=new Map,this._lastMouseOffsetX=0,this._selectedGroup=-1,this._keyboardFocusedGroup=-1,this._selectedGroupBackroundColor=E.instance().patchColorText(I.SelectedGroupBackground,E.ColorUsage.Background),this._selectedGroupBorderColor=E.instance().patchColorText(I.SelectedGroupBorder,E.ColorUsage.Background),this._offsetWidth,this._offsetHeight,this._canvasGL,this._dragStartX,this._dragStartY,this._lastMouseOffsetX,this._lastMouseOffsetY,this._minimumBoundary}willHide(){this.hideHighlight()}setBarHeight(e){this._barHeight=e}setTextBaseline(e){this._textBaseline=e}setTextPadding(e){this._textPadding=e}enableRuler(e){this._rulerEnabled=e}alwaysShowVerticalScroll(){this._chartViewport.alwaysShowVerticalScroll()}disableRangeSelection(){this._chartViewport.disableRangeSelection()}highlightEntry(e){this._highlightedEntryIndex!==e&&this._dataProvider.entryColor(e)&&(this._highlightedEntryIndex=e,this._updateElementPosition(this._highlightElement,this._highlightedEntryIndex),this.dispatchEventToListeners(F.EntryHighlighted,e))}hideHighlight(){this._entryInfo.removeChildren(),this._highlightedEntryIndex=-1,this._updateElementPosition(this._highlightElement,this._highlightedEntryIndex),this.dispatchEventToListeners(F.EntryHighlighted,-1)}_createCandyStripePattern(){const e=17;this._candyStripeCanvas.width=e,this._candyStripeCanvas.height=e;const t=this._candyStripeCanvas.getContext("2d");if(t){t.translate(8.5,8.5),t.rotate(.25*Math.PI),t.translate(-8.5,-8.5),t.fillStyle="rgba(255, 0, 0, 0.4)";for(let e=-17;e<34;e+=3)t.fillRect(e,-17,1,51)}}_resetCanvas(){const e=window.devicePixelRatio,t=Math.round(this._offsetWidth*e),i=Math.round(this._offsetHeight*e);this._canvas.width=t,this._canvas.height=i,this._canvas.style.width=t/e+"px",this._canvas.style.height=i/e+"px",this._useWebGL&&(this._canvasGL.width=t,this._canvasGL.height=i,this._canvasGL.style.width=t/e+"px",this._canvasGL.style.height=i/e+"px")}windowChanged(e,t,i){this._flameChartDelegate.windowChanged(e,t,i)}updateRangeSelection(e,t){this._flameChartDelegate.updateRangeSelection(e,t)}setSize(e,t){this._offsetWidth=e,this._offsetHeight=t}_startDragging(e){return this.hideHighlight(),this._maxDragOffset=0,this._dragStartX=e.pageX,this._dragStartY=e.pageY,!0}_dragging(e){const t=e.pageX-this._dragStartX,i=e.pageY-this._dragStartY;this._maxDragOffset=Math.max(this._maxDragOffset,Math.sqrt(t*t+i*i))}_endDragging(e){this._updateHighlight()}_timelineData(){if(!this._dataProvider)return null;const e=this._dataProvider.timelineData();return(e!==this._rawTimelineData||e&&e.entryStartTimes.length!==this._rawTimelineDataLength)&&this._processTimelineData(e),this._rawTimelineData||null}_revealEntry(e){const t=this._timelineData();if(!t)return;const i=this._chartViewport.windowLeftTime(),s=this._chartViewport.windowRightTime(),r=t.entryStartTimes[e],n=t.entryTotalTimes[e],o=r+n;let a=Math.min(n,s-i);const l=t.entryLevels[e];this._chartViewport.setScrollOffset(this._levelToOffset(l),this._levelHeight(l));const h=(s-i)/this._offsetWidth;if(a=Math.max(a,30*h),i>o){const e=i-o+a;this.windowChanged(i-e,s-e,!0)}else if(s<r){const e=r-s+a;this.windowChanged(i+e,s+e,!0)}}setWindowTimes(e,t,i){this._chartViewport.setWindowTimes(e,t,i),this._updateHighlight()}_onMouseMove(e){const t=e;if(this._lastMouseOffsetX=t.offsetX,this._lastMouseOffsetY=t.offsetY,this._enabled()&&!this._chartViewport.isDragging())return this._coordinatesToGroupIndex(t.offsetX,t.offsetY,!0)>=0?(this.hideHighlight(),void(this._viewportElement.style.cursor="pointer")):void this._updateHighlight()}_updateHighlight(){const e=this._coordinatesToEntryIndex(this._lastMouseOffsetX,this._lastMouseOffsetY);if(-1!==e)this._chartViewport.isDragging()||(this._updatePopover(e),this._viewportElement.style.cursor=this._dataProvider.canJumpToEntry(e)?"pointer":"default",this.highlightEntry(e));else{this.hideHighlight();const e=this._coordinatesToGroupIndex(this._lastMouseOffsetX,this._lastMouseOffsetY,!1);e>=0&&this._rawTimelineData&&this._rawTimelineData.groups&&this._rawTimelineData.groups[e].selectable?this._viewportElement.style.cursor="pointer":this._viewportElement.style.cursor="default"}}_onMouseOut(){this._lastMouseOffsetX=-1,this._lastMouseOffsetY=-1,this.hideHighlight()}_updatePopover(e){if(e===this._highlightedEntryIndex)return void this._updatePopoverOffset();this._entryInfo.removeChildren();const t=this._dataProvider.prepareHighlightedEntryInfo(e);t&&(this._entryInfo.appendChild(t),this._updatePopoverOffset())}_updatePopoverOffset(){const e=this._lastMouseOffsetX,t=this._lastMouseOffsetY,i=this._entryInfo.parentElement?this._entryInfo.parentElement.clientWidth:0,s=this._entryInfo.parentElement?this._entryInfo.parentElement.clientHeight:0,r=this._entryInfo.clientWidth,n=this._entryInfo.clientHeight;let o,a;for(let h=0;h<4;++h){const d=2&h?-10-r:10,c=1&h?-6-n:6;if(o=l.clamp(e+d,0,i-r),a=l.clamp(t+c,0,s-n),o>=e||e>=o+r||a>=t||t>=a+n)break}this._entryInfo.style.left=o+"px",this._entryInfo.style.top=a+"px"}_onClick(e){const t=e;this.focus();if(this._maxDragOffset>5)return;this._selectGroup(this._coordinatesToGroupIndex(t.offsetX,t.offsetY,!1)),this._toggleGroupExpand(this._coordinatesToGroupIndex(t.offsetX,t.offsetY,!0));const i=this._timelineData();if(t.shiftKey&&-1!==this._highlightedEntryIndex&&i){const e=i.entryStartTimes[this._highlightedEntryIndex],t=e+i.entryTotalTimes[this._highlightedEntryIndex];this._chartViewport.setRangeSelection(e,t)}else this._chartViewport.onClick(t),this.dispatchEventToListeners(F.EntryInvoked,this._highlightedEntryIndex)}_selectGroup(e){if(e<0||this._selectedGroup===e)return;if(!this._rawTimelineData)return;const t=this._rawTimelineData.groups;if(!t)return;this._keyboardFocusedGroup=e,this._scrollGroupIntoView(e);const i=t[e].name;t[e].selectable?(this._selectedGroup=e,this._flameChartDelegate.updateSelectedGroup(this,t[e]),this._resetCanvas(),this._draw(),c.alert(a`${i} selected`,this._canvas)):(this._deselectAllGroups(),c.alert(a`${i} hovered`,this._canvas))}_deselectAllGroups(){this._selectedGroup=-1,this._flameChartDelegate.updateSelectedGroup(this,null),this._resetCanvas(),this._draw()}_deselectAllEntries(){this._selectedEntryIndex=-1,this._resetCanvas(),this._draw()}_isGroupFocused(e){return e===this._selectedGroup||e===this._keyboardFocusedGroup}_scrollGroupIntoView(e){if(e<0)return;if(!this._rawTimelineData)return;const t=this._rawTimelineData.groups,i=this._groupOffsets;if(!i||!t)return;const s=i[e];let r=i[e+1];e===t.length-1&&(r+=t[e].style.padding);const n=0===e?0:s,o=Math.min(r-n,this._chartViewport.chartHeight());this._chartViewport.setScrollOffset(n,o)}_toggleGroupExpand(e){e<0||!this._isGroupCollapsible(e)||this._rawTimelineData&&this._rawTimelineData.groups&&this._expandGroup(e,!this._rawTimelineData.groups[e].expanded)}_expandGroup(e,t=!0,i=!1){if(e<0||!this._isGroupCollapsible(e))return;if(!this._rawTimelineData)return;const s=this._rawTimelineData.groups;if(!s)return;const r=s[e];if(r.expanded=t,this._groupExpansionState[r.name]=r.expanded,this._groupExpansionSetting&&this._groupExpansionSetting.set(this._groupExpansionState),this._updateLevelPositions(),this._updateHighlight(),!r.expanded){const t=this._timelineData();if(t){const i=t.entryLevels[this._selectedEntryIndex];this._selectedEntryIndex>=0&&i>=r.startLevel&&(e>=s.length-1||s[e+1].startLevel>i)&&(this._selectedEntryIndex=-1)}}if(this._updateHeight(),this._resetCanvas(),this._draw(),this._scrollGroupIntoView(e),!i){const t=s[e].name,i=r.expanded?a`${t} expanded`:a`${t} collapsed`;c.alert(i,this._canvas)}}_onKeyDown(e){if(!m.KeyboardShortcut.hasNoModifiers(e)||!this._timelineData())return;!this._handleSelectionNavigation(e)&&this._rawTimelineData&&this._rawTimelineData.groups&&this._handleKeyboardGroupNavigation(e)}bindCanvasEvent(e,t){this._canvas.addEventListener(e,t)}_handleKeyboardGroupNavigation(e){const t=e;let i=!1,s=!1;"ArrowUp"===t.code?i=this._selectPreviousGroup():"ArrowDown"===t.code?i=this._selectNextGroup():"ArrowLeft"===t.code?this._keyboardFocusedGroup>=0&&(this._expandGroup(this._keyboardFocusedGroup,!1),i=!0):"ArrowRight"===t.code?this._keyboardFocusedGroup>=0&&(this._expandGroup(this._keyboardFocusedGroup,!0),this._selectFirstChild(),i=!0):"Enter"===t.key&&(s=this._selectFirstEntryInCurrentGroup(),i=s),i&&!s&&this._deselectAllEntries(),i&&t.consume(!0)}_selectFirstEntryInCurrentGroup(){if(!this._rawTimelineData)return!1;const e=this._rawTimelineData.groups;if(this._keyboardFocusedGroup<0||!e)return!1;const t=e[this._keyboardFocusedGroup].startLevel;if(t<0)return!1;if(this._keyboardFocusedGroup<e.length-1&&e[this._keyboardFocusedGroup+1].startLevel===t)return!1;if(!this._timelineLevels)return!1;const i=this._timelineLevels[t][0];return this._expandGroup(this._keyboardFocusedGroup,!0),this.setSelectedEntry(i),!0}_selectPreviousGroup(){if(this._keyboardFocusedGroup<=0)return!1;const e=this._getGroupIndexToSelect(-1);return this._selectGroup(e),!0}_selectNextGroup(){if(!this._rawTimelineData||!this._rawTimelineData.groups)return!1;if(this._keyboardFocusedGroup>=this._rawTimelineData.groups.length-1)return!1;const e=this._getGroupIndexToSelect(1);return this._selectGroup(e),!0}_getGroupIndexToSelect(e){if(!this._rawTimelineData||!this._rawTimelineData.groups)throw new Error("No raw timeline data");const t=this._rawTimelineData.groups;let i,s,r=this._keyboardFocusedGroup;do{r+=e,i=this._rawTimelineData.groups[r].name,s=-1!==this._keyboardFocusedGroup&&t[r].style.nestingLevel>t[this._keyboardFocusedGroup].style.nestingLevel}while(r>0&&r<t.length-1&&(!i||s));return r}_selectFirstChild(){if(!this._rawTimelineData||!this._rawTimelineData.groups)return;const e=this._rawTimelineData.groups;if(this._keyboardFocusedGroup<0||this._keyboardFocusedGroup>=e.length-1)return;const t=this._keyboardFocusedGroup+1;e[t].style.nestingLevel>e[this._keyboardFocusedGroup].style.nestingLevel&&this._selectGroup(t)}_handleSelectionNavigation(e){if(-1===this._selectedEntryIndex)return!1;const t=this._timelineData();if(!t)return!1;function i(e,i){if(!t)throw new Error("No timeline data");const s=t.entryStartTimes[e],r=t.entryStartTimes[i],n=s+t.entryTotalTimes[e];return s<r+t.entryTotalTimes[i]&&r<n}const s=e,r=m.Keys;if(s.keyCode===r.Left.code||s.keyCode===r.Right.code){const i=t.entryLevels[this._selectedEntryIndex],n=this._timelineLevels?this._timelineLevels[i]:[];let o=n.lowerBound(this._selectedEntryIndex);return o+=s.keyCode===r.Left.code?-1:1,e.consume(!0),o>=0&&o<n.length&&this.dispatchEventToListeners(F.EntrySelected,n[o]),!0}if(s.keyCode===r.Up.code||s.keyCode===r.Down.code){let e=t.entryLevels[this._selectedEntryIndex];if(e+=s.keyCode===r.Up.code?-1:1,e<0||this._timelineLevels&&e>=this._timelineLevels.length)return this._deselectAllEntries(),s.consume(!0),!0;const n=t.entryStartTimes[this._selectedEntryIndex]+t.entryTotalTimes[this._selectedEntryIndex]/2,o=this._timelineLevels?this._timelineLevels[e]:[];let a=o.upperBound(n,(function(e,i){if(!t)throw new Error("No timeline data");return e-t.entryStartTimes[i]}))-1;return!i(this._selectedEntryIndex,o[a])&&(++a,a>=o.length||!i(this._selectedEntryIndex,o[a]))?"ArrowDown"!==s.code&&(this._deselectAllEntries(),s.consume(!0),!0):(s.consume(!0),this.dispatchEventToListeners(F.EntrySelected,o[a]),!0)}return"Enter"===e.key&&(e.consume(!0),this.dispatchEventToListeners(F.EntryInvoked,this._selectedEntryIndex),!0)}_coordinatesToEntryIndex(e,t){if(e<0||t<0)return-1;const i=this._timelineData();if(!i)return-1;if(t+=this._chartViewport.scrollOffset(),!this._visibleLevelOffsets)throw new Error("No visible level offsets");const s=this._visibleLevelOffsets.upperBound(t)-1;if(s<0||this._visibleLevels&&!this._visibleLevels[s])return-1;if(t-this._visibleLevelOffsets[s]>this._levelHeight(s))return-1;for(const[t,r]of this._markerPositions)if(i.entryLevels[t]===s&&r.x<=e&&e<r.x+r.width)return t;const r=i.entryStartTimes,n=this._timelineLevels?this._timelineLevels[s]:[];if(!n||!n.length)return-1;const o=this._chartViewport.pixelToTime(e),a=Math.max(n.upperBound(o,((e,t)=>e-r[t]))-1,0);function l(t){if(void 0===t)return!1;if(!i)return!1;const s=r[t],n=i.entryTotalTimes[t],o=this._chartViewport.timeToPosition(s),a=this._chartViewport.timeToPosition(s+n);return o-3<e&&e<a+3}let h=n[a];return l.call(this,h)?h:(h=n[a+1],l.call(this,h)?h:-1)}_coordinatesToGroupIndex(e,t,i){if(!this._rawTimelineData||!this._rawTimelineData.groups||!this._groupOffsets)return-1;if(e<0||t<0)return-1;t+=this._chartViewport.scrollOffset();const s=this._rawTimelineData.groups||[],r=this._groupOffsets.upperBound(t)-1;if(r<0||r>=s.length)return-1;const n=i?s[r].style.height:this._groupOffsets[r+1]-this._groupOffsets[r];if(t-this._groupOffsets[r]>=n)return-1;if(!i)return r;const o=this._canvas.getContext("2d");o.save(),o.font=s[r].style.font;const a=this._headerLeftPadding+this._labelWidthForGroup(o,s[r]);return o.restore(),e>a?-1:r}_markerIndexAtPosition(e){const t=this._timelineData();if(!t)return-1;const i=t.markers;if(!i)return-1;const s=this._chartViewport.pixelToTime(e),r=this._chartViewport.pixelToTime(e-4),n=this._chartViewport.pixelToTime(e+4);let o=-1,a=1/0;for(let e=this._markerIndexBeforeTime(r);e<i.length&&i[e].startTime()<n;e++){const t=Math.abs(i[e].startTime()-s);t<a&&(o=e,a=t)}return o}_markerIndexBeforeTime(e){const t=this._timelineData();if(!t)throw new Error("No timeline data");if(!t.markers)throw new Error("No timeline markers");return t.markers.lowerBound(e,((e,t)=>e-t.startTime()))}_draw(){const e=this._timelineData();if(!e)return;const t=this._visibleLevelOffsets?this._visibleLevelOffsets:[],i=this._offsetWidth,s=this._offsetHeight,r=this._canvas.getContext("2d");r.save();const n=window.devicePixelRatio,o=this._chartViewport.scrollOffset();r.scale(n,n),r.fillStyle="rgba(0, 0, 0, 0)",r.fillRect(0,0,i,s),r.translate(0,-o);const a="11px "+v.fontFamily();r.font=a;const l=r.createPattern(this._candyStripeCanvas,"repeat"),h=e.entryTotalTimes,d=e.entryStartTimes,c=e.entryLevels,m=this._chartViewport.timeToPixel(),u=[],g=[],f=this._textPadding,p=2*f+_.measureTextWidth(r,"â€¦"),w=this._chartViewport.pixelToTimeOffset(p),y=Math.max(t.upperBound(o)-1,0);this._markerPositions.clear();let E=-1;if("groups"in e&&Array.isArray(e.groups)){const t=e.groups.find((e=>!!e.track&&"CrRendererMain"===e.track.name));t&&(E=t.startLevel)}const T=new Map;for(let e=y;e<this._dataProvider.maxStackDepth()&&!(this._levelToOffset(e)>o+s);++e){if(!this._visibleLevels||!this._visibleLevels[e])continue;if(!this._timelineLevels)continue;const t=this._timelineLevels[e];let i=1/0;for(let e=t.lowerBound(this._chartViewport.windowRightTime(),((e,t)=>e-d[t]))-1;e>=0;--e){const s=t[e],r=h[s];if(isNaN(r)){g.push(s);continue}(r>=w||this._forceDecorationCache&&this._forceDecorationCache[s])&&u.push(s);const n=d[s];if(n+r<=this._chartViewport.windowLeftTime())break;if(this._useWebGL)continue;const o=this._timeToPositionClipped(n);if(!(o>=i)&&(i=o,this._entryColorsCache)){const e=this._entryColorsCache[s];let t=T.get(e);t||(t={indexes:[]},T.set(e,t)),t.indexes.push(s)}}}if(this._useWebGL)this._drawGL();else{r.save(),this._forEachGroupInViewport(((e,t,s,n,o)=>{this._isGroupFocused(t)&&(r.fillStyle=this._selectedGroupBackroundColor,r.fillRect(0,e,i,o-s.style.padding))})),r.restore();for(const[e,{indexes:t}]of T){r.beginPath();for(let e=0;e<t.length;++e){const i=t[e],s=h[i];if(isNaN(s))continue;const n=d[i],o=this._timeToPositionClipped(n),a=c[i],l=this._levelHeight(a),_=this._levelToOffset(a),m=this._timeToPositionClipped(n+s),u=Math.max(m-o,1);r.rect(o,_,u-.4,l-1)}r.fillStyle=e,r.fill(),r.beginPath();for(let e=0;e<t.length;++e){const i=t[e],s=h[i];if(!(c[i]===E))continue;if(isNaN(s)||s<50)continue;const n=d[i],o=this._timeToPositionClipped(n+50),a=c[i],l=this._levelHeight(a),_=this._levelToOffset(a),m=this._timeToPositionClipped(n+s),u=Math.max(m-o,1);r.rect(o,_,u-.4,l-1)}l&&(r.fillStyle=l,r.fill())}}r.textBaseline="alphabetic",r.beginPath();let S=-1,b=-1/0;for(let e=g.length-1;e>=0;--e){const t=g[e],i=this._dataProvider.entryTitle(t);if(!i)continue;const s=d[t],n=c[t];S!==n&&(b=-1/0);const o=Math.max(this._chartViewport.timeToPosition(s),b),a=this._levelToOffset(n),l=this._levelHeight(n),h=4,m=Math.ceil(_.measureTextWidth(r,i))+2*h;b=o+m+1,S=n,this._markerPositions.set(t,{x:o,width:m}),r.fillStyle=this._dataProvider.entryColor(t),r.fillRect(o,a,m,l-1),r.fillStyle="white",r.fillText(i,o+h,a+l-this._textBaseline)}r.strokeStyle="rgba(0, 0, 0, 0.2)",r.stroke();for(let e=0;e<u.length;++e){const t=u[e],s=d[t],n=this._timeToPositionClipped(s),o=Math.min(this._timeToPositionClipped(s+h[t]),i)+1-n,l=c[t],g=this._levelToOffset(l);let p=this._dataProvider.entryTitle(t);p&&p.length&&(r.font=this._dataProvider.entryFont(t)||a,p=_.trimTextMiddle(r,p,o-2*f));const v=this._chartViewport.timeToPosition(s),w=this._levelHeight(l);this._dataProvider.decorateEntry(t,r,p,n,g,o,w,v,m)||p&&p.length&&(r.fillStyle=this._dataProvider.textColor(t),r.fillText(p,n+f,g+w-this._textBaseline))}r.restore(),this._drawGroupHeaders(i,s),this._drawFlowEvents(r,i,s),this._drawMarkers();const x=R.calculateGridOffsets(this),L=Array.from(this._dataProvider.navStartTimes().values());let C=0;const P=e=>{if(0===L.length)return this.formatValue(e,x.precision);L.length>C+1&&e>L[C+1].startTime&&C++;const t=L[C];return t&&(e-=t.startTime-this.zeroTime()),this.formatValue(e,x.precision)};R.drawCanvasGrid(r,x),this._rulerEnabled&&R.drawCanvasHeaders(r,x,P,3,B),this._updateElementPosition(this._highlightElement,this._highlightedEntryIndex),this._updateElementPosition(this._selectedElement,this._selectedEntryIndex),this._updateMarkerHighlight()}_initWebGL(){const e=this._canvasGL.getContext("webgl");if(!e)return console.error("Failed to obtain WebGL context."),void(this._useWebGL=!1);function t(e,t,i){const s=e.createShader(t);return s?(e.shaderSource(s,i),e.compileShader(s),e.getShaderParameter(s,e.COMPILE_STATUS)?s:(console.error("Shader compile error: "+e.getShaderInfoLog(s)),e.deleteShader(s),null)):null}const i=t(e,e.VERTEX_SHADER,"\n      attribute vec2 aVertexPosition;\n      attribute float aVertexColor;\n\n      uniform vec2 uScalingFactor;\n      uniform vec2 uShiftVector;\n\n      varying mediump vec2 vPalettePosition;\n\n      void main() {\n        vec2 shiftedPosition = aVertexPosition - uShiftVector;\n        gl_Position = vec4(shiftedPosition * uScalingFactor + vec2(-1.0, 1.0), 0.0, 1.0);\n        vPalettePosition = vec2(aVertexColor, 0.5);\n      }"),s=t(e,e.FRAGMENT_SHADER,"\n      varying mediump vec2 vPalettePosition;\n      uniform sampler2D uSampler;\n\n      void main() {\n        gl_FragColor = texture2D(uSampler, vPalettePosition);\n      }"),r=e.createProgram();if(!r||!i||!s)return;if(e.attachShader(r,i),e.attachShader(r,s),e.linkProgram(r),!e.getProgramParameter(r,e.LINK_STATUS))throw this._shaderProgram=null,new Error("Unable to initialize the shader program: "+e.getProgramInfoLog(r));this._shaderProgram=r,e.useProgram(r),this._vertexBuffer=e.createBuffer(),this._colorBuffer=e.createBuffer(),this._uScalingFactor=e.getUniformLocation(r,"uScalingFactor"),this._uShiftVector=e.getUniformLocation(r,"uShiftVector");const n=e.getUniformLocation(r,"uSampler");e.uniform1i(n,0),this._aVertexPosition=e.getAttribLocation(this._shaderProgram,"aVertexPosition"),this._aVertexColor=e.getAttribLocation(this._shaderProgram,"aVertexColor"),e.enableVertexAttribArray(this._aVertexPosition),e.enableVertexAttribArray(this._aVertexColor)}_setupGLGeometry(){const t=this._canvasGL.getContext("webgl");if(!t)return;const i=this._timelineData();if(!i)return;const s=i.entryTotalTimes,r=i.entryStartTimes,n=i.entryLevels,o=new Float32Array(6*s.length*2);let a=new Uint8Array(6*s.length),l=0;const h=new Map,d=[],c=this._visibleLevels||[],_=this._rawTimelineData||{groups:[]},m=new Array(c.length),u=_.groups||[];this._forEachGroup(((e,t,i)=>{if(i.style.useFirstLineForOverview||!this._isGroupCollapsible(t)||i.expanded)return;let s=t+1;for(;s<u.length&&u[s].style.nestingLevel>i.style.nestingLevel;)++s;const r=s<u.length?u[s].startLevel:this._dataProvider.maxStackDepth();for(let t=i.startLevel;t<r;++t)m[t]=e}));for(let t=0;t<s.length;++t){const i=n[t],_=m[i];if(!c[i]&&!_)continue;if(!this._entryColorsCache)continue;const u=this._entryColorsCache[t];if(!u)continue;let g=h.get(u);if(void 0===g){const t=e.Color.parse(u);if(t){const e=t.canonicalRGBA();e[3]=Math.round(255*e[3]),g=d.length/4,d.push(...e),256===g&&(a=new Uint8Array(a))}g&&h.set(u,g)}for(let e=0;e<6;++e)g&&(a[l+e]=g);const f=2*l,p=r[t]-this._minimumBoundary,v=p+s[t],w=_||this._levelToOffset(i),y=w+this._levelHeight(i)-1;o[f+0]=p,o[f+1]=w,o[f+2]=v,o[f+3]=w,o[f+4]=p,o[f+5]=y,o[f+6]=p,o[f+7]=y,o[f+8]=v,o[f+9]=w,o[f+10]=v,o[f+11]=y,l+=6}this._vertexCount=l;const g=t.createTexture();t.bindTexture(t.TEXTURE_2D,g),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.activeTexture(t.TEXTURE0);const f=d.length/4,p=f>=256,v=p?Math.min(65536,t.getParameter(t.MAX_TEXTURE_SIZE)):256;console.assert(f<=v,"Too many colors");const w=p?t.UNSIGNED_SHORT:t.UNSIGNED_BYTE;if(p){const e=65536/v;for(let t=0;t<l;++t)a[t]*=e}const y=new Uint8Array(4*v);y.set(d),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,v,1,0,t.RGBA,t.UNSIGNED_BYTE,y),this._vertexBuffer&&this._aVertexPosition&&(t.bindBuffer(t.ARRAY_BUFFER,this._vertexBuffer),t.bufferData(t.ARRAY_BUFFER,o,t.STATIC_DRAW),t.vertexAttribPointer(this._aVertexPosition,2,t.FLOAT,!1,0,0)),this._colorBuffer&&this._aVertexColor&&(t.bindBuffer(t.ARRAY_BUFFER,this._colorBuffer),t.bufferData(t.ARRAY_BUFFER,a,t.STATIC_DRAW),t.vertexAttribPointer(this._aVertexColor,1,w,!0,0,0))}_drawGL(){const e=this._canvasGL.getContext("webgl");if(!e)return;const t=this._timelineData();if(!t)return;if(this._prevTimelineData&&t.entryTotalTimes===this._prevTimelineData.entryTotalTimes||(this._prevTimelineData=t,this._setupGLGeometry()),e.viewport(0,0,this._canvasGL.width,this._canvasGL.height),!this._vertexCount)return;const i=[2/this.boundarySpan(),-2*window.devicePixelRatio/this._canvasGL.height],s=[this.minimumBoundary()-this.zeroTime(),this._chartViewport.scrollOffset()];this._uScalingFactor&&e.uniform2fv(this._uScalingFactor,i),this._uShiftVector&&e.uniform2fv(this._uShiftVector,s),e.drawArrays(e.TRIANGLES,0,this._vertexCount)}_drawGroupHeaders(t,i){const s=this._canvas.getContext("2d"),r=this._chartViewport.scrollOffset(),n=window.devicePixelRatio;if(!this._rawTimelineData)return;const o=this._rawTimelineData.groups||[];if(!o.length)return;const a=this._groupOffsets;if(null==a)return;const l=a[a.length-1],h=E.ColorUsage;s.save(),s.scale(n,n),s.translate(0,-r);const d="11px "+v.fontFamily();function c(e){s.moveTo(0,e),s.lineTo(t,e)}function _(e,t,i){const r=this._arrowSide*Math.sqrt(3)/2,n=Math.round(r/2);s.save(),s.translate(e,t),s.rotate(i?Math.PI/2:0),s.moveTo(-n,-this._arrowSide/2),s.lineTo(-n,this._arrowSide/2),s.lineTo(r-n,0),s.restore()}s.font=d,s.fillStyle=E.instance().patchColorText("#fff",h.Background),this._forEachGroupInViewport(((e,i,r)=>{const n=r.style.padding;n<5||s.fillRect(0,e-n+2,t,n-4)})),o.length&&l<r+i&&s.fillRect(0,l+2,t,r+i-l),s.strokeStyle=E.instance().patchColorText("#eee",h.Background),s.beginPath(),this._forEachGroupInViewport(((e,t,i,s)=>{s||i.style.padding<4||c(e-2.5)})),c(l+1.5),s.stroke(),this._forEachGroupInViewport(((e,i,r)=>{if(r.style.useFirstLineForOverview)return;if(!this._isGroupCollapsible(i)||r.expanded)return void(!r.style.shareHeaderLine&&this._isGroupFocused(i)&&(s.fillStyle=r.style.backgroundColor,s.fillRect(0,e,t,r.style.height)));if(this._useWebGL)return;let n=i+1;for(;n<o.length&&o[n].style.nestingLevel>r.style.nestingLevel;)n++;const a=n<o.length?o[n].startLevel:this._dataProvider.maxStackDepth();this._drawCollapsedOverviewForGroup(r,e,a)})),s.save(),this._forEachGroupInViewport(((t,i,r)=>{if(s.font=r.style.font,this._isGroupCollapsible(i)&&!r.expanded||r.style.shareHeaderLine){const n=this._labelWidthForGroup(s,r)+2;if(this._isGroupFocused(i))s.fillStyle=this._selectedGroupBackroundColor;else{const t=e.Color.parse(r.style.backgroundColor);t&&(s.fillStyle=t.setAlpha(.8).asString(null))}s.fillRect(this._headerLeftPadding-this._headerLabelXPadding,t+this._headerLabelYPadding,n,r.style.height-2*this._headerLabelYPadding)}s.fillStyle=r.style.color,s.fillText(r.name,Math.floor(this._expansionArrowIndent*(r.style.nestingLevel+1)+this._arrowSide),t+r.style.height-this._textBaseline)})),s.restore(),s.fillStyle=E.instance().patchColorText("#6e6e6e",h.Foreground),s.beginPath(),this._forEachGroupInViewport(((e,t,i)=>{this._isGroupCollapsible(t)&&_.call(this,this._expansionArrowIndent*(i.style.nestingLevel+1),e+i.style.height-this._textBaseline-this._arrowSide/2,Boolean(i.expanded))})),s.fill(),s.strokeStyle=E.instance().patchColorText("#ddd",h.Background),s.beginPath(),s.stroke(),this._forEachGroupInViewport(((e,t,i,r,n)=>{if(this._isGroupFocused(t)){const t=2,r=10;s.fillStyle=this._selectedGroupBorderColor,s.fillRect(0,e-t,t,n-i.style.padding+2*t),s.fillRect(0,e-t,r,t),s.fillRect(0,e+n-i.style.padding,r,t)}})),s.restore()}_forEachGroup(e){if(!this._rawTimelineData)return;const t=this._rawTimelineData.groups||[];if(!t.length)return;const i=this._groupOffsets;if(!i)return;const s=[{nestingLevel:-1,visible:!0}];for(let r=0;r<t.length;++r){const n=i[r],o=t[r];let a=!0,l=s[s.length-1];for(;l&&l.nestingLevel>=o.style.nestingLevel;)s.pop(),a=!1,l=s[s.length-1];l=s[s.length-1];const h=!!l&&l.visible,d=h&&(!this._isGroupCollapsible(r)||o.expanded);s.push({nestingLevel:o.style.nestingLevel,visible:Boolean(d)});const c=r===t.length-1?i[r+1]+o.style.padding:i[r+1];h&&e(n,r,o,a,c-n)}}_forEachGroupInViewport(e){const t=this._chartViewport.scrollOffset();this._forEachGroup(((i,s,r,n,o)=>{i-r.style.padding>t+this._offsetHeight||i+o<t||e(i,s,r,n,o)}))}_labelWidthForGroup(e,t){return _.measureTextWidth(e,t.name)+this._expansionArrowIndent*(t.style.nestingLevel+1)+2*this._headerLabelXPadding}_drawCollapsedOverviewForGroup(e,i,s){const r=new t.SegmentedRange((function(e,t){return e.data===t.data&&e.end+.4>t.end?e:null})),n=this._chartViewport.windowLeftTime(),o=this._chartViewport.windowRightTime(),a=this._canvas.getContext("2d"),l=e.style.height;if(!this._rawTimelineData)return;const h=this._rawTimelineData.entryStartTimes,d=this._rawTimelineData.entryTotalTimes,c=this._chartViewport.timeToPixel();for(let _=e.startLevel;_<s;++_){const s=this._timelineLevels?this._timelineLevels[_]:[];let m=1/0;for(let _=s.lowerBound(o,((e,t)=>e-h[t]))-1;_>=0;--_){const o=s[_],u=h[o],g=this._timeToPositionClipped(u),f=u+d[o];if(isNaN(f)||g>=m)continue;if(f<=n)break;m=g;const p=this._entryColorsCache?this._entryColorsCache[o]:"",v=this._timeToPositionClipped(f);if(e.style.useDecoratorsForOverview&&this._dataProvider.forceDecoration(o)){const e=this._chartViewport.timeToPosition(u),t=v-g;a.beginPath(),a.fillStyle=p,a.fillRect(g,i,t,l-1),this._dataProvider.decorateEntry(o,a,"",g,i,t,l,e,c)}else r.append(new t.Segment(g,v,p))}}const _=r.segments().slice().sort(((e,t)=>e.data.localeCompare(t.data)));let m;a.beginPath();for(let e=0;e<_.length;++e){const t=_[e];m!==_[e].data&&(a.fill(),a.beginPath(),m=_[e].data,a.fillStyle=m),a.rect(t.begin,i,t.end-t.begin,l)}a.fill()}_drawFlowEvents(e,t,i){e.save();const s=window.devicePixelRatio,r=this._chartViewport.scrollOffset();e.scale(s,s),e.translate(0,-r),e.fillStyle="#7f5050",e.strokeStyle="#7f5050";const n=this._timelineData();if(!n)return;const o=n.flowStartTimes.lowerBound(this._chartViewport.windowRightTime());e.lineWidth=.5;for(let t=0;t<o;++t){if(!n.flowEndTimes[t]||n.flowEndTimes[t]<this._chartViewport.windowLeftTime())continue;const i=this._chartViewport.timeToPosition(n.flowStartTimes[t]),s=this._chartViewport.timeToPosition(n.flowEndTimes[t]),r=n.flowStartLevels[t],o=n.flowEndLevels[t],a=this._levelToOffset(r)+this._levelHeight(r)/2,l=this._levelToOffset(o)+this._levelHeight(o)/2,h=Math.min((s-i)/4,40),d=(l-a)/10,c=30,_=n.flowEndTimes[t]-n.flowStartTimes[t]<1?a:c+Math.max(0,a+d*(t%c)),m=[];m.push({x:i,y:a}),m.push({x:i+6,y:a}),m.push({x:i+h+12,y:a}),m.push({x:i+h,y:_}),m.push({x:i+2*h,y:_}),m.push({x:s-2*h,y:_}),m.push({x:s-h,y:_}),m.push({x:s-h-12,y:l}),m.push({x:s-6,y:l}),e.beginPath(),e.moveTo(m[0].x,m[0].y),e.lineTo(m[1].x,m[1].y),e.bezierCurveTo(m[2].x,m[2].y,m[3].x,m[3].y,m[4].x,m[4].y),e.lineTo(m[5].x,m[5].y),e.bezierCurveTo(m[6].x,m[6].y,m[7].x,m[7].y,m[8].x,m[8].y),e.stroke(),e.beginPath(),e.arc(i,a,2,-Math.PI/2,Math.PI/2,!1),e.fill(),e.beginPath(),e.moveTo(s,l),e.lineTo(s-6,l-3),e.lineTo(s-6,l+3),e.fill()}e.restore()}_drawMarkers(){const e=this._timelineData();if(!e)return;const t=e.markers,i=this._markerIndexBeforeTime(this.minimumBoundary()),s=this.maximumBoundary(),r=this._chartViewport.timeToPixel(),n=this._canvas.getContext("2d");n.save();const o=window.devicePixelRatio;n.scale(o,o),n.translate(0,3);const a=B-1;for(let e=i;e<t.length;e++){const i=t[e].startTime();if(i>s)break;t[e].draw(n,this._chartViewport.timeToPosition(i),a,r)}n.restore()}_updateMarkerHighlight(){const e=this._markerHighlighElement;e.parentElement&&e.remove();const t=this._highlightedMarkerIndex;if(-1===t)return;const i=this._timelineData();if(!i)return;const s=i.markers[t],r=this._timeToPositionClipped(s.startTime());u.Tooltip.install(e,s.title()||"");const n=e.style;n.left=r+"px",n.backgroundColor=s.color(),this._viewportElement.appendChild(e)}_processTimelineData(e){if(!e)return this._timelineLevels=null,this._visibleLevelOffsets=null,this._visibleLevels=null,this._groupOffsets=null,this._rawTimelineData=null,this._forceDecorationCache=null,this._entryColorsCache=null,this._rawTimelineDataLength=0,this._selectedGroup=-1,this._keyboardFocusedGroup=-1,void this._flameChartDelegate.updateSelectedGroup(this,null);this._rawTimelineData=e,this._rawTimelineDataLength=e.entryStartTimes.length,this._forceDecorationCache=new Int8Array(this._rawTimelineDataLength),this._entryColorsCache=new Array(this._rawTimelineDataLength);for(let e=0;e<this._rawTimelineDataLength;++e)this._forceDecorationCache[e]=this._dataProvider.forceDecoration(e)?1:0,this._entryColorsCache[e]=this._dataProvider.entryColor(e);const t=new Uint32Array(this._dataProvider.maxStackDepth()+1);for(let i=0;i<e.entryLevels.length;++i)++t[e.entryLevels[i]];const i=new Array(t.length);for(let e=0;e<i.length;++e)i[e]=new Uint32Array(t[e]),t[e]=0;for(let s=0;s<e.entryLevels.length;++s){const r=e.entryLevels[s];i[r][t[r]++]=s}this._timelineLevels=i;const s=this._rawTimelineData.groups||[];for(let e=0;e<s.length;++e){const t=this._groupExpansionState[s[e].name];void 0!==t&&(s[e].expanded=t)}this._updateLevelPositions(),this._updateHeight(),this._selectedGroup=e.selectedGroup?s.indexOf(e.selectedGroup):-1,this._keyboardFocusedGroup=this._selectedGroup,this._flameChartDelegate.updateSelectedGroup(this,e.selectedGroup)}_updateLevelPositions(){const e=this._dataProvider.maxStackDepth(),t=this._rawTimelineData&&this._rawTimelineData.groups||[];this._visibleLevelOffsets=new Uint32Array(e+1),this._visibleLevelHeights=new Uint32Array(e),this._visibleLevels=new Uint16Array(e),this._groupOffsets=new Uint32Array(t.length+1);let i=-1,s=this._rulerEnabled?B+2:2,r=!0;const n=[{nestingLevel:-1,visible:!0}],o=Math.max(e,t.length?t[t.length-1].startLevel+1:0);let a;for(a=0;a<o;++a){let o,l=!0;for(;i<t.length-1&&a===t[i+1].startLevel;){++i,o=t[i].style;let e=!0,a=n[n.length-1];for(;a&&a.nestingLevel>=o.nestingLevel;)n.pop(),e=!1,a=n[n.length-1];const h=!(i>=0&&this._isGroupCollapsible(i))||t[i].expanded;a=n[n.length-1],l=!!a&&a.visible,r=Boolean(h)&&l,n.push({nestingLevel:o.nestingLevel,visible:r}),l&&(s+=e?0:o.padding),this._groupOffsets[i]=s,l&&!o.shareHeaderLine&&(s+=o.height)}if(a>=e)continue;const h=i>=0&&a===t[i].startLevel,d=l&&(r||h&&t[i].style.useFirstLineForOverview);let c;if(i>=0){const e=t[i],s=e.style;c=h&&!s.shareHeaderLine||s.collapsible&&!e.expanded?s.height:s.itemsHeight||this._barHeight}else c=this._barHeight;this._visibleLevels[a]=d?1:0,this._visibleLevelOffsets[a]=s,this._visibleLevelHeights[a]=c,(d||l&&o&&o.shareHeaderLine&&h)&&(s+=this._visibleLevelHeights[a])}i>=0&&(this._groupOffsets[i+1]=s),this._visibleLevelOffsets[a]=s,this._useWebGL&&this._setupGLGeometry()}_isGroupCollapsible(e){if(!this._rawTimelineData)return;const t=this._rawTimelineData.groups||[],i=t[e].style;if(!i.shareHeaderLine||!i.collapsible)return Boolean(i.collapsible);const s=e+1>=t.length;if(!s&&t[e+1].style.nestingLevel>i.nestingLevel)return!0;return(s?this._dataProvider.maxStackDepth():t[e+1].startLevel)!==t[e].startLevel+1||i.height!==i.itemsHeight}setSelectedEntry(e){this._selectedEntryIndex!==e&&(-1!==e&&this._chartViewport.hideRangeSelection(),this._selectedEntryIndex=e,this._revealEntry(e),this._updateElementPosition(this._selectedElement,this._selectedEntryIndex))}_updateElementPosition(e,t){if(e.classList.add("hidden"),-1===t)return;const i=this._timelineData();if(!i)return;const s=i.entryStartTimes[t],r=i.entryTotalTimes[t];let n=0,o=0,a=!0;if(Number.isNaN(r)){const e=this._markerPositions.get(t);e?(n=e.x,o=e.width):a=!1}else n=this._chartViewport.timeToPosition(s),o=r*this._chartViewport.timeToPixel();if(n+o<=0||n>=this._offsetWidth)return;const l=n+o/2;o=Math.max(o,2),n=l-o/2;const h=i.entryLevels[t],d=this._levelToOffset(h)-this._chartViewport.scrollOffset(),c=this._levelHeight(h),_=e.style;_.left=n+"px",_.top=d+"px",_.width=o+"px",_.height=c-1+"px",e.classList.toggle("hidden",!a),this._viewportElement.appendChild(e)}_timeToPositionClipped(e){return l.clamp(this._chartViewport.timeToPosition(e),0,this._offsetWidth)}_levelToOffset(e){if(!this._visibleLevelOffsets)throw new Error("No visible level offsets");return this._visibleLevelOffsets[e]}_levelHeight(e){if(!this._visibleLevelHeights)throw new Error("No visible level heights");return this._visibleLevelHeights[e]}_updateBoundaries(){this._totalTime=this._dataProvider.totalTime(),this._minimumBoundary=this._dataProvider.minimumBoundary(),this._chartViewport.setBoundaries(this._minimumBoundary,this._totalTime)}_updateHeight(){const e=this._levelToOffset(this._dataProvider.maxStackDepth())+2;this._chartViewport.setContentHeight(e)}onResize(){this.scheduleUpdate()}update(){this._timelineData()&&(this._resetCanvas(),this._updateHeight(),this._updateBoundaries(),this._draw(),this._chartViewport.isDragging()||this._updateHighlight())}reset(){this._chartViewport.reset(),this._rawTimelineData=null,this._rawTimelineDataLength=0,this._highlightedMarkerIndex=-1,this._highlightedEntryIndex=-1,this._selectedEntryIndex=-1,this._textWidth=new Map,this._chartViewport.scheduleUpdate()}scheduleUpdate(){this._chartViewport.scheduleUpdate()}_enabled(){return 0!==this._rawTimelineDataLength}computePosition(e){return this._chartViewport.timeToPosition(e)}formatValue(e,t){return this._dataProvider.formatValue(e-this.zeroTime(),t)}maximumBoundary(){return this._chartViewport.windowRightTime()}minimumBoundary(){return this._chartViewport.windowLeftTime()}zeroTime(){return this._dataProvider.minimumBoundary()}boundarySpan(){return this.maximumBoundary()-this.minimumBoundary()}}const B=15;const F={CanvasFocused:Symbol("CanvasFocused"),EntryInvoked:Symbol("EntryInvoked"),EntrySelected:Symbol("EntrySelected"),EntryHighlighted:Symbol("EntryHighlighted")},I={SelectedGroupBackground:"hsl(215, 85%, 98%)",SelectedGroupBorder:"hsl(216, 68%, 54%)"};var W=Object.freeze({__proto__:null,FlameChartDelegate:class{windowChanged(e,t,i){}updateRangeSelection(e,t){}updateSelectedGroup(e,t){}},FlameChart:M,HeaderHeight:B,MinimalTimeWindowMs:.5,TimelineData:class{constructor(e,t,i,s){this.entryLevels=e,this.entryTotalTimes=t,this.entryStartTimes=i,this.groups=s||[],this.markers=[],this.flowStartTimes=[],this.flowStartLevels=[],this.flowEndTimes=[],this.flowEndLevels=[],this.selectedGroup=null}},FlameChartDataProvider:class{minimumBoundary(){throw new Error("Not implemented")}totalTime(){throw new Error("Not implemented")}formatValue(e,t){throw new Error("Not implemented")}maxStackDepth(){throw new Error("Not implemented")}timelineData(){throw new Error("Not implemented")}prepareHighlightedEntryInfo(e){throw new Error("Not implemented")}canJumpToEntry(e){throw new Error("Not implemented")}entryTitle(e){throw new Error("Not implemented")}entryFont(e){throw new Error("Not implemented")}entryColor(e){throw new Error("Not implemented")}decorateEntry(e,t,i,s,r,n,o,a,l){throw new Error("Not implemented")}forceDecoration(e){throw new Error("Not implemented")}textColor(e){throw new Error("Not implemented")}navStartTimes(){throw new Error("Not implemented")}},FlameChartMarker:class{startTime(){throw new Error("Not implemented")}color(){throw new Error("Not implemented")}title(){throw new Error("Not implemented")}draw(e,t,i,s){throw new Error("Not implemented")}},Events:F,Colors:I,Group:undefined,GroupStyle:undefined});class z extends d.VBox{constructor(e){super(),this.registerRequiredCSS("perf_ui/chartViewport.css",{enableLegacyPatching:!0}),this._delegate=e,this.viewportElement=this.contentElement.createChild("div","fill"),this.viewportElement.addEventListener("mousemove",this._updateCursorPosition.bind(this),!1),this.viewportElement.addEventListener("mouseout",this._onMouseOut.bind(this),!1),this.viewportElement.addEventListener("wheel",this._onMouseWheel.bind(this),!1),this.viewportElement.addEventListener("keydown",this._onChartKeyDown.bind(this),!1),this.viewportElement.addEventListener("keyup",this._onChartKeyUp.bind(this),!1),_.installDragHandle(this.viewportElement,this._startDragging.bind(this),this._dragging.bind(this),this._endDragging.bind(this),"-webkit-grabbing",null),_.installDragHandle(this.viewportElement,this._startRangeSelection.bind(this),this._rangeSelectionDragging.bind(this),this._endRangeSelection.bind(this),"text",null),this._alwaysShowVerticalScroll=!1,this._rangeSelectionEnabled=!0,this._vScrollElement=this.contentElement.createChild("div","chart-viewport-v-scroll"),this._vScrollContent=this._vScrollElement.createChild("div"),this._vScrollElement.addEventListener("scroll",this._onScroll.bind(this),!1),this._selectionOverlay=this.contentElement.createChild("div","chart-viewport-selection-overlay hidden"),this._selectedTimeSpanLabel=this._selectionOverlay.createChild("div","time-span"),this._cursorElement=this.contentElement.createChild("div","chart-cursor-element hidden"),this.reset(),this._isDragging,this._totalHeight,this._offsetHeight,this._vScrollElement.scrollTop,this._scrollTop,this._rangeSelectionStart=null,this._rangeSelectionEnd=null,this._dragStartPointX,this._dragStartPointY,this._dragStartScrollTop,this._visibleLeftTime,this._visibleRightTime,this._offsetWidth,this._targetLeftTime,this._targetRightTime,this._selectionOffsetShiftX,this._selectionOffsetShiftY,this._selectionStartX,this._lastMouseOffsetX,this._minimumBoundary,this._totalTime}alwaysShowVerticalScroll(){this._alwaysShowVerticalScroll=!0,this._vScrollElement.classList.add("always-show-scrollbar")}disableRangeSelection(){this._rangeSelectionEnabled=!1,this._rangeSelectionStart=null,this._rangeSelectionEnd=null,this._updateRangeSelectionOverlay()}isDragging(){return this._isDragging}elementsToRestoreScrollPositionsFor(){return[this._vScrollElement]}_updateScrollBar(){const e=this._alwaysShowVerticalScroll||this._totalHeight>this._offsetHeight;this._vScrollElement.classList.contains("hidden")===e&&(this._vScrollElement.classList.toggle("hidden",!e),this._updateContentElementSize())}onResize(){this._updateScrollBar(),this._updateContentElementSize(),this.scheduleUpdate()}reset(){this._vScrollElement.scrollTop=0,this._scrollTop=0,this._rangeSelectionStart=null,this._rangeSelectionEnd=null,this._isDragging=!1,this._dragStartPointX=0,this._dragStartPointY=0,this._dragStartScrollTop=0,this._visibleLeftTime=0,this._visibleRightTime=0,this._offsetWidth=0,this._offsetHeight=0,this._totalHeight=0,this._targetLeftTime=0,this._targetRightTime=0,this._updateContentElementSize()}_updateContentElementSize(){let e=this._vScrollElement.offsetLeft;e||(e=this.contentElement.offsetWidth),this._offsetWidth=e,this._offsetHeight=this.contentElement.offsetHeight,this._delegate.setSize(this._offsetWidth,this._offsetHeight)}setContentHeight(e){this._totalHeight=e,this._vScrollContent.style.height=e+"px",this._updateScrollBar(),this._updateContentElementSize(),this._scrollTop+this._offsetHeight<=e||(this._scrollTop=Math.max(0,e-this._offsetHeight),this._vScrollElement.scrollTop=this._scrollTop)}setScrollOffset(e,t){t=t||0,this._vScrollElement.scrollTop>e?this._vScrollElement.scrollTop=e:this._vScrollElement.scrollTop<e-this._offsetHeight+t&&(this._vScrollElement.scrollTop=e-this._offsetHeight+t)}scrollOffset(){return this._vScrollElement.scrollTop}chartHeight(){return this._offsetHeight}setBoundaries(e,t){this._minimumBoundary=e,this._totalTime=t}_onMouseWheel(e){const t=e,s=t.shiftKey!==("zoom"===i.Settings.instance().moduleSetting("flamechartMouseWheelAction").get()),r=!s&&(t.deltaY||53===Math.abs(t.deltaX)),n=s&&Math.abs(t.deltaX)>Math.abs(t.deltaY);if(r)this._vScrollElement.scrollTop+=(t.deltaY||t.deltaX)/53*this._offsetHeight/8;else if(n)this._handlePanGesture(t.deltaX,!0);else{const e=1/53;this._handleZoomGesture(Math.pow(1.2,(t.deltaY||t.deltaX)*e)-1)}e.consume(!0)}_startDragging(e){return!e.shiftKey&&(this._isDragging=!0,this._dragStartPointX=e.pageX,this._dragStartPointY=e.pageY,this._dragStartScrollTop=this._vScrollElement.scrollTop,this.viewportElement.style.cursor="",!0)}_dragging(e){const t=this._dragStartPointX-e.pageX;this._dragStartPointX=e.pageX,this._handlePanGesture(t);const i=this._dragStartPointY-e.pageY;this._vScrollElement.scrollTop=this._dragStartScrollTop+i}_endDragging(){this._isDragging=!1}_startRangeSelection(e){if(!e.shiftKey||!this._rangeSelectionEnabled)return!1;this._isDragging=!0,this._selectionOffsetShiftX=e.offsetX-e.pageX,this._selectionOffsetShiftY=e.offsetY-e.pageY,this._selectionStartX=e.offsetX;const t=this._selectionOverlay.style;return t.left=this._selectionStartX+"px",t.width="1px",this._selectedTimeSpanLabel.textContent="",this._selectionOverlay.classList.remove("hidden"),!0}_endRangeSelection(){this._isDragging=!1,this._selectionStartX=null}hideRangeSelection(){this._selectionOverlay.classList.add("hidden"),this._rangeSelectionStart=null,this._rangeSelectionEnd=null}setRangeSelection(e,t){this._rangeSelectionEnabled&&(this._rangeSelectionStart=Math.min(e,t),this._rangeSelectionEnd=Math.max(e,t),this._updateRangeSelectionOverlay(),this._delegate.updateRangeSelection(this._rangeSelectionStart,this._rangeSelectionEnd))}onClick(e){const t=e,i=this.pixelToTime(t.offsetX);null!==this._rangeSelectionStart&&null!==this._rangeSelectionEnd&&i>=this._rangeSelectionStart&&i<=this._rangeSelectionEnd||this.hideRangeSelection()}_rangeSelectionDragging(e){const t=l.clamp(e.pageX+this._selectionOffsetShiftX,0,this._offsetWidth),i=this.pixelToTime(this._selectionStartX||0),s=this.pixelToTime(t);this.setRangeSelection(i,s)}_updateRangeSelectionOverlay(){const e=this._rangeSelectionStart||0,t=this._rangeSelectionEnd||0,i=100,s=l.clamp(this.timeToPosition(e),-100,this._offsetWidth+i),r=l.clamp(this.timeToPosition(t),-100,this._offsetWidth+i),n=this._selectionOverlay.style;n.left=s+"px",n.width=r-s+"px";const o=t-e;this._selectedTimeSpanLabel.textContent=Number.preciseMillisToString(o,2)}_onScroll(){this._scrollTop=this._vScrollElement.scrollTop,this.scheduleUpdate()}_onMouseOut(){this._lastMouseOffsetX=-1,this._showCursor(!1)}_updateCursorPosition(e){const t=e;this._showCursor(t.shiftKey),this._cursorElement.style.left=t.offsetX+"px",this._lastMouseOffsetX=t.offsetX}pixelToTime(e){return this.pixelToTimeOffset(e)+this._visibleLeftTime}pixelToTimeOffset(e){return e*(this._visibleRightTime-this._visibleLeftTime)/this._offsetWidth}timeToPosition(e){return Math.floor((e-this._visibleLeftTime)/(this._visibleRightTime-this._visibleLeftTime)*this._offsetWidth)}timeToPixel(){return this._offsetWidth/(this._visibleRightTime-this._visibleLeftTime)}_showCursor(e){this._cursorElement.classList.toggle("hidden",!e||this._isDragging)}_onChartKeyDown(e){const t=e;this._showCursor(t.shiftKey),this._handleZoomPanKeys(e)}_onChartKeyUp(e){const t=e;this._showCursor(t.shiftKey)}_handleZoomPanKeys(e){if(!m.KeyboardShortcut.hasNoModifiers(e))return;const t=e,i=t.shiftKey?.8:.3,s=t.shiftKey?320:160;switch(t.code){case"KeyA":this._handlePanGesture(-s,!0);break;case"KeyD":this._handlePanGesture(s,!0);break;case"KeyW":this._handleZoomGesture(-i);break;case"KeyS":this._handleZoomGesture(i);break;default:return}e.consume(!0)}_handleZoomGesture(e){const t={left:this._targetLeftTime,right:this._targetRightTime},i=this.pixelToTime(this._lastMouseOffsetX);t.left+=(t.left-i)*e,t.right+=(t.right-i)*e,this._requestWindowTimes(t,!0)}_handlePanGesture(e,t){const i={left:this._targetLeftTime,right:this._targetRightTime},s=l.clamp(this.pixelToTimeOffset(e),this._minimumBoundary-i.left,this._totalTime+this._minimumBoundary-i.right);i.left+=s,i.right+=s,this._requestWindowTimes(i,Boolean(t))}_requestWindowTimes(e,t){const i=this._minimumBoundary+this._totalTime;e.left<this._minimumBoundary?(e.right=Math.min(e.right+this._minimumBoundary-e.left,i),e.left=this._minimumBoundary):e.right>i&&(e.left=Math.max(e.left-e.right+i,this._minimumBoundary),e.right=i),e.right-e.left<.5||this._delegate.windowChanged(e.left,e.right,t)}scheduleUpdate(){this._updateTimerId||this._cancelWindowTimesAnimation||(this._updateTimerId=this.element.window().requestAnimationFrame((()=>{this._updateTimerId=0,this._update()})))}_update(){this._updateRangeSelectionOverlay(),this._delegate.update()}setWindowTimes(e,t,i){if(e!==this._targetLeftTime||t!==this._targetRightTime){if(!i||0===this._visibleLeftTime||this._visibleRightTime===1/0||0===e&&t===1/0||e===1/0&&t===1/0)return this._targetLeftTime=e,this._targetRightTime=t,this._visibleLeftTime=e,this._visibleRightTime=t,void this.scheduleUpdate();this._cancelWindowTimesAnimation&&(this._cancelWindowTimesAnimation(),this._visibleLeftTime=this._targetLeftTime,this._visibleRightTime=this._targetRightTime),this._targetLeftTime=e,this._targetRightTime=t,this._cancelWindowTimesAnimation=_.animateFunction(this.element.window(),function(e,t){this._visibleLeftTime=e,this._visibleRightTime=t,this._update()}.bind(this),[{from:this._visibleLeftTime,to:e},{from:this._visibleRightTime,to:t}],100,(()=>{this._cancelWindowTimesAnimation=null}))}}windowLeftTime(){return this._visibleLeftTime}windowRightTime(){return this._visibleRightTime}}var V=Object.freeze({__proto__:null,ChartViewportDelegate:class{windowChanged(e,t,i){}updateRangeSelection(e,t){}setSize(e,t){}update(){}},ChartViewport:z});class O extends d.HBox{constructor(){super(!0),this.registerRequiredCSS("perf_ui/filmStripView.css",{enableLegacyPatching:!0}),this.contentElement.classList.add("film-strip-view"),this._statusLabel=this.contentElement.createChild("div","label"),this.reset(),this.setMode(A.TimeBased),this._zeroTime,this._spanTime,this._model}static _setImageData(e,t){t&&(e.src="data:image/jpg;base64,"+t)}setMode(e){this._mode=e,this.contentElement.classList.toggle("time-based",e===A.TimeBased),this.update()}setModel(e,t,i){this._model=e,this._zeroTime=t,this._spanTime=i;e.frames().length?this.update():this.reset()}createFrameElement(e){const t=e.timestamp,i=Number.millisToString(t-this._zeroTime),r=document.createElement("div");r.classList.add("frame"),u.Tooltip.install(r,s.UIString("Doubleclick to zoom image. Click to view preceding requests.")),r.createChild("div","time").textContent=i,r.tabIndex=0,r.setAttribute("aria-label",a`Screenshot for ${i} - select to view preceding requests.`),c.markAsButton(r);const n=r.createChild("div","thumbnail").createChild("img");return n.alt=a`Screenshot`,r.addEventListener("mousedown",this._onMouseEvent.bind(this,H.FrameSelected,t),!1),r.addEventListener("mouseenter",this._onMouseEvent.bind(this,H.FrameEnter,t),!1),r.addEventListener("mouseout",this._onMouseEvent.bind(this,H.FrameExit,t),!1),r.addEventListener("dblclick",this._onDoubleClick.bind(this,e),!1),r.addEventListener("focusin",this._onMouseEvent.bind(this,H.FrameEnter,t),!1),r.addEventListener("focusout",this._onMouseEvent.bind(this,H.FrameExit,t),!1),r.addEventListener("keydown",(e=>{"Enter"!==e.code&&"Space"!==e.code||this._onMouseEvent(H.FrameSelected,t)})),e.imageDataPromise().then(O._setImageData.bind(null,n)).then((function(){return r}))}frameByTime(e){const t=this._model.frames(),i=Math.max(t.upperBound(e,(function(e,t){return e-t.timestamp}))-1,0);return t[i]}update(){if(!this._model)return;const e=this._model.frames();if(!e.length)return;if(this._mode===A.FrameBased)return void Promise.all(e.map(this.createFrameElement.bind(this))).then(s.bind(this));const t=this.contentElement.clientWidth,i=this._spanTime/t;function s(e){this.contentElement.removeChildren();for(let t=0;t<e.length;++t)this.contentElement.appendChild(e[t])}this.createFrameElement(e[0]).then(function(e){const r=Math.ceil(_.measurePreferredSize(e,this.contentElement).width);if(!r)return;const n=[];for(let e=r;e<t;e+=r){const t=e*i+this._zeroTime;n.push(this.createFrameElement(this.frameByTime(t)).then(o))}function o(e){return e.style.width=r+"px",e}Promise.all(n).then(s.bind(this))}.bind(this))}onResize(){this._mode!==A.FrameBased&&this.update()}_onMouseEvent(e,t){this.dispatchEventToListeners(e,t)}_onDoubleClick(e){new N(e,this._zeroTime)}reset(){this._zeroTime=0,this.contentElement.removeChildren(),this.contentElement.appendChild(this._statusLabel)}setStatusText(e){this._statusLabel.textContent=e}}const H={FrameSelected:Symbol("FrameSelected"),FrameEnter:Symbol("FrameEnter"),FrameExit:Symbol("FrameExit")},A={TimeBased:"TimeBased",FrameBased:"FrameBased"};class N{constructor(e,t){const i=_.createTextButton("â—€",this._onPrevFrame.bind(this));u.Tooltip.install(i,s.UIString("Previous frame"));const r=_.createTextButton("â–¶",this._onNextFrame.bind(this));u.Tooltip.install(r,s.UIString("Next frame")),this._fragment=g.Fragment.build`
      <x-widget flex=none margin=12px>
        <x-hbox overflow=auto border='1px solid #ddd'>
          <img $=image style="max-height: 80vh; max-width: 80vw"></img>
        </x-hbox>
        <x-hbox x-center justify-content=center margin-top=10px>
          ${i}
          <x-hbox $=time margin=8px></x-hbox>
          ${r}
        </x-hbox>
      </x-widget>
    `,this._widget=this._fragment.element(),this._widget.tabIndex=0,this._widget.addEventListener("keydown",this._keyDown.bind(this),!1),this._frames=e.model().frames(),this._index=e.index,this._zeroTime=t||e.model().zeroTime(),this._dialog=null,this._render()}_resize(){this._dialog||(this._dialog=new f.Dialog,this._dialog.contentElement.appendChild(this._widget),this._dialog.setDefaultFocusedElement(this._widget),this._dialog.show()),this._dialog.setSizeBehavior(p.SizeBehavior.MeasureContent)}_keyDown(e){const t=e;switch(t.key){case"ArrowLeft":v.isMac()&&t.metaKey?this._onFirstFrame():this._onPrevFrame();break;case"ArrowRight":v.isMac()&&t.metaKey?this._onLastFrame():this._onNextFrame();break;case"Home":this._onFirstFrame();break;case"End":this._onLastFrame()}}_onPrevFrame(){this._index>0&&--this._index,this._render()}_onNextFrame(){this._index<this._frames.length-1&&++this._index,this._render()}_onFirstFrame(){this._index=0,this._render()}_onLastFrame(){this._index=this._frames.length-1,this._render()}_render(){const e=this._frames[this._index];return this._fragment.$("time").textContent=Number.millisToString(e.timestamp-this._zeroTime),e.imageDataPromise().then((()=>{const e=this._fragment.$("image");return O._setImageData(e,null)})).then(this._resize.bind(this))}}var U=Object.freeze({__proto__:null,FilmStripView:O,Events:H,Modes:A,Dialog:N});var X=Object.freeze({__proto__:null,GCActionDelegate:class{handleAction(e,t){for(const e of T.TargetManager.instance().models(S.HeapProfilerModel))e.collectGarbage();return!0}}});let $,Y;class K{constructor(){this._helper=new q("performance")}static instance(e={forceNew:null}){const{forceNew:t}=e;return $&&!t||($=new K),$}reset(){this._helper.reset()}_appendLegacyCPUProfile(e){const t=e.target(),i=[e.profileHead],s=(e.profileEndTime-e.profileStartTime)/e.totalHitCount;for(;i.length;){const e=i.pop().children;for(let r=0;r<e.length;++r){const n=e[r];if(i.push(n),n.url&&n.positionTicks)for(let e=0;e<n.positionTicks.length;++e){const i=n.positionTicks[e],r=i.line,o=i.ticks*s;this._helper.addLineData(t,n.url,r,o)}}}}appendCPUProfile(e){if(!e.lines)return this._appendLegacyCPUProfile(e),void this._helper.scheduleUpdate();const t=e.target();if(e.samples){for(let i=1;i<e.samples.length;++i){const s=e.lines[i];if(!s)continue;const r=e.nodeByIndex(i);if(!r)continue;const n=r.scriptId||r.url;if(!n)continue;const o=e.timestamps[i]-e.timestamps[i-1];this._helper.addLineData(t,n,s,o)}this._helper.scheduleUpdate()}}}class j{constructor(){this._helper=new q("memory")}static instance(e={forceNew:null}){const{forceNew:t}=e;return Y&&!t||(Y=new j),Y}reset(){this._helper.reset()}appendHeapProfile(e,t){const i=this._helper;!function e(s){if(s.children.forEach(e),!s.selfSize)return;const r=Number(s.callFrame.scriptId)||s.callFrame.url;if(!r)return;const n=s.callFrame.lineNumber+1;i.addLineData(t,r,n,s.selfSize)}(e.head),i.scheduleUpdate()}}class q{constructor(e){this._type=e,this._locationPool=new L.LiveLocationPool,this._updateTimer=null,this.reset(),this._lineData}reset(){this._lineData=new Map,this.scheduleUpdate()}addLineData(e,t,i,s){let r=this._lineData.get(e);r||(r=new Map,this._lineData.set(e,r));let n=r.get(t);n||(n=new Map,r.set(t,n)),n.set(i,(n.get(i)||0)+s)}scheduleUpdate(){this._updateTimer||(this._updateTimer=setTimeout((()=>{this._updateTimer=null,this._doUpdate()}),0))}_doUpdate(){this._locationPool.disposeAll(),P.WorkspaceImpl.instance().uiSourceCodes().forEach((e=>e.removeDecorationsForType(this._type)));for(const e of this._lineData){const t=e[0],i=t?t.model(b.DebuggerModel):null,s=e[1];for(const e of s){const t=e[0],s=e[1],r=i||"string"!=typeof t?null:P.WorkspaceImpl.instance().uiSourceCodeForURL(t);if(i||r)for(const e of s){const s=e[0]-1,n=e[1];if(r)r.addLineDecoration(s,this._type,n);else if(i){const e="string"==typeof t?i.createRawLocationByURL(t,s,0):i.createRawLocationByScriptId(String(t),s,0);e&&new Z(e,this._type,n,this._locationPool)}}}}}}class Z{constructor(e,t,i,s){this._type=t,this._time=i,this._uiLocation=null,C.DebuggerWorkspaceBinding.instance().createLiveLocation(e,this.updateLocation.bind(this),s)}async updateLocation(e){this._uiLocation&&this._uiLocation.uiSourceCode.removeDecorationsForType(this._type),this._uiLocation=await e.uiLocation(),this._uiLocation&&this._uiLocation.uiSourceCode.addLineDecoration(this._uiLocation.lineNumber,this._type,this._time)}}var J=Object.freeze({__proto__:null,Performance:K,Memory:j,Helper:q,Presentation:Z,LineDecorator:class{decorate(e,t,i){const s="CodeMirror-gutter-"+i,r=e.decorationsForType(i);if(t.uninstallGutter(s),r&&r.size){t.installGutter(s,!1);for(const e of r){const r=e.data(),n=this._createElement(i,r);t.setGutterDecoration(e.range().startLine,s,n)}}}_createElement(e,t){const i=document.createElement("div");if(i.classList.add("text-editor-line-marker-text"),"performance"===e){const e=l.clamp(Math.log10(1+10*t)/5,.02,1);i.textContent=s.UIString("%.1f",t),i.style.backgroundColor=`hsla(44, 100%, 50%, ${e.toFixed(3)})`,i.createChild("span","line-marker-units").textContent=a`ms`}else{const e=l.clamp(Math.log10(1+.002*t)/5,.02,1);let r,n;i.style.backgroundColor=`hsla(217, 100%, 70%, ${e.toFixed(3)})`,(t/=1e3)>=1e3?(r=a`MB`,n=(t/=1e3)>=20?0:1):(r=a`kB`,n=0),i.textContent=s.UIString(`%.${n}f`,t),i.createChild("span","line-marker-units").textContent=r}return i}}});var Q=Object.freeze({__proto__:null,LiveHeapProfile:class{constructor(){this._running=!1,this._sessionId=0,this._loadEventCallback=()=>{},this._setting=i.Settings.instance().moduleSetting("memoryLiveHeapProfile"),this._setting.addChangeListener((e=>e.data?this._startProfiling():this._stopProfiling())),this._setting.get()&&this._startProfiling()}run(){return Promise.resolve()}modelAdded(e){e.startSampling(1e4)}modelRemoved(e){}async _startProfiling(){if(this._running)return;this._running=!0;const e=this._sessionId;T.TargetManager.instance().observeModels(S.HeapProfilerModel,this),T.TargetManager.instance().addModelListener(x.ResourceTreeModel,x.Events.Load,this._loadEventFired,this);do{const t=T.TargetManager.instance().models(S.HeapProfilerModel),i=await Promise.all(t.map((e=>e.getSamplingProfile())));if(e!==this._sessionId)break;j.instance().reset();for(let e=0;e<i.length;++e){const s=i[e];s&&j.instance().appendHeapProfile(s,t[e].target())}await Promise.race([new Promise((e=>setTimeout(e,w.isUnderTest()?10:5e3))),new Promise((e=>{this._loadEventCallback=e}))])}while(e===this._sessionId);T.TargetManager.instance().unobserveModels(S.HeapProfilerModel,this),T.TargetManager.instance().removeModelListener(x.ResourceTreeModel,x.Events.Load,this._loadEventFired,this);for(const e of T.TargetManager.instance().models(S.HeapProfilerModel))e.stopSampling();j.instance().reset()}_stopProfiling(){this._running&&(this._running=!1,this._sessionId++)}_loadEventFired(){this._loadEventCallback()}}});const ee=new Map;let te;function ie(){if(te)return te;const e=new Map;return e.set(Protocol.Network.ResourcePriority.VeryLow,s.UIString("Lowest")),e.set(Protocol.Network.ResourcePriority.Low,s.UIString("Low")),e.set(Protocol.Network.ResourcePriority.Medium,s.UIString("Medium")),e.set(Protocol.Network.ResourcePriority.High,s.UIString("High")),e.set(Protocol.Network.ResourcePriority.VeryHigh,s.UIString("Highest")),te=e,e}const se=new Map;var re=Object.freeze({__proto__:null,uiLabelForNetworkPriority:function(e){return ie().get(e)||""},uiLabelToNetworkPriority:function(e){return 0===ee.size&&ie().forEach(((e,t)=>ee.set(e,t))),ee.get(e)||""},priorityUILabelMap:ie,networkPriorityWeight:function(e){return 0===se.size&&(se.set(Protocol.Network.ResourcePriority.VeryLow,1),se.set(Protocol.Network.ResourcePriority.Low,2),se.set(Protocol.Network.ResourcePriority.Medium,3),se.set(Protocol.Network.ResourcePriority.High,4),se.set(Protocol.Network.ResourcePriority.VeryHigh,5)),se.get(e)||0}});class ne{constructor(e,t){this.element=document.createElement("div"),this.element.id=e+"-overview-container",this._grid=new R,this._grid.element.id=e+"-overview-grid",this._grid.setScrollTop(0),this.element.appendChild(this._grid.element),this._window=new oe(this.element,this._grid.dividersLabelBarElement,t)}clientWidth(){return this.element.clientWidth}updateDividers(e){this._grid.updateDividers(e)}addEventDividers(e){this._grid.addEventDividers(e)}removeEventDividers(){this._grid.removeEventDividers()}reset(){this._window.reset()}windowLeft(){return this._window.windowLeft||0}windowRight(){return this._window.windowRight||0}setWindow(e,t){this._window._setWindow(e,t)}addEventListener(e,t,i){return this._window.addEventListener(e,t,i)}setClickHandler(e){this._window.setClickHandler(e)}zoom(e,t){this._window._zoom(e,t)}setResizeEnabled(e){this._window.setEnabled(e)}}class oe extends r.ObjectWrapper{constructor(e,t,i){super(),this._parentElement=e,c.markAsGroup(this._parentElement),this._calculator=i,c.setAccessibleName(this._parentElement,a`Overview grid window`),_.installDragHandle(this._parentElement,this._startWindowSelectorDragging.bind(this),this._windowSelectorDragging.bind(this),this._endWindowSelectorDragging.bind(this),"text",null),t&&_.installDragHandle(t,this._startWindowDragging.bind(this),this._windowDragging.bind(this),null,"-webkit-grabbing","-webkit-grab"),this._parentElement.addEventListener("wheel",this._onMouseWheel.bind(this),!0),this._parentElement.addEventListener("dblclick",this._resizeWindowMaximum.bind(this),!0),h.appendStyle(this._parentElement,"perf_ui/overviewGrid.css",{enableLegacyPatching:!0}),this._leftResizeElement=e.createChild("div","overview-grid-window-resizer"),_.installDragHandle(this._leftResizeElement,this._resizerElementStartDragging.bind(this),this._leftResizeElementDragging.bind(this),null,"ew-resize"),this._rightResizeElement=e.createChild("div","overview-grid-window-resizer"),_.installDragHandle(this._rightResizeElement,this._resizerElementStartDragging.bind(this),this._rightResizeElementDragging.bind(this),null,"ew-resize"),c.setAccessibleName(this._leftResizeElement,a`Left Resizer`),c.markAsSlider(this._leftResizeElement);this._leftResizeElement.addEventListener("keydown",(e=>this._handleKeyboardResizing(e,!1))),c.setAccessibleName(this._rightResizeElement,a`Right Resizer`),c.markAsSlider(this._rightResizeElement);this._rightResizeElement.addEventListener("keydown",(e=>this._handleKeyboardResizing(e,!0))),this._rightResizeElement.addEventListener("focus",this._onRightResizeElementFocused.bind(this)),this._leftCurtainElement=e.createChild("div","window-curtain-left"),this._rightCurtainElement=e.createChild("div","window-curtain-right"),this.reset(),this._overviewWindowSelector,this._offsetLeft,this._dragStartPoint,this._dragStartLeft,this._dragStartRight}_onRightResizeElementFocused(){this._parentElement.scrollLeft=0}reset(){this.windowLeft=0,this.windowRight=1,this.setEnabled(!0),this._updateCurtains()}setEnabled(e){this._enabled=e,this._rightResizeElement.tabIndex=e?0:-1,this._leftResizeElement.tabIndex=e?0:-1}setClickHandler(e){this._clickHandler=e}_resizerElementStartDragging(e){const t=e,i=e.target;return!!this._enabled&&(this._resizerParentOffsetLeft=t.pageX-t.offsetX-i.offsetLeft,e.stopPropagation(),!0)}_leftResizeElementDragging(e){const t=e;this._resizeWindowLeft(t.pageX-(this._resizerParentOffsetLeft||0)),e.preventDefault()}_rightResizeElementDragging(e){const t=e;this._resizeWindowRight(t.pageX-(this._resizerParentOffsetLeft||0)),e.preventDefault()}_handleKeyboardResizing(e,t){const i=e,s=e.target;let r=!1;if("ArrowLeft"===i.key||"ArrowRight"===i.key){"ArrowRight"===i.key&&(r=!0);const n=this._getNewResizerPosition(s.offsetLeft,r,i.ctrlKey);t?this._resizeWindowRight(n):this._resizeWindowLeft(n),e.consume(!0)}}_getNewResizerPosition(e,t,i){let s,r=i?10:2;r=t?r:-Math.abs(r);return s=e+3.5+r,t&&s<10?s=10:!t&&s>this._parentElement.clientWidth-10&&(s=this._parentElement.clientWidth-10),s}_startWindowSelectorDragging(e){if(!this._enabled)return!1;const t=e;this._offsetLeft=this._parentElement.totalOffsetLeft();const i=t.x-this._offsetLeft;return this._overviewWindowSelector=new le(this._parentElement,i),!0}_windowSelectorDragging(e){if(!this._overviewWindowSelector)return;const t=e;this._overviewWindowSelector._updatePosition(t.x-this._offsetLeft),e.preventDefault()}_endWindowSelectorDragging(e){if(!this._overviewWindowSelector)return;const t=e,i=this._overviewWindowSelector._close(t.x-this._offsetLeft);delete this._overviewWindowSelector;if(i.end-i.start<3){if(this._clickHandler&&this._clickHandler.call(null,e))return;const t=i.end;i.start=Math.max(0,t-7),i.end=Math.min(this._parentElement.clientWidth,t+7)}else i.end-i.start<14&&(this._parentElement.clientWidth-i.end>14?i.end=i.start+14:i.start=i.end-14);this._setWindowPosition(i.start,i.end)}_startWindowDragging(e){const t=e;return this._dragStartPoint=t.pageX,this._dragStartLeft=this.windowLeft||0,this._dragStartRight=this.windowRight||0,e.stopPropagation(),!0}_windowDragging(e){const t=e;t.preventDefault();let i=(t.pageX-this._dragStartPoint)/this._parentElement.clientWidth;this._dragStartLeft+i<0&&(i=-this._dragStartLeft),this._dragStartRight+i>1&&(i=1-this._dragStartRight),this._setWindow(this._dragStartLeft+i,this._dragStartRight+i)}_resizeWindowLeft(e){e<10?e=0:e>this._rightResizeElement.offsetLeft-4&&(e=this._rightResizeElement.offsetLeft-4),this._setWindowPosition(e,null)}_resizeWindowRight(e){e>this._parentElement.clientWidth-10?e=this._parentElement.clientWidth:e<this._leftResizeElement.offsetLeft+14&&(e=this._leftResizeElement.offsetLeft+14),this._setWindowPosition(null,e)}_resizeWindowMaximum(){this._setWindowPosition(0,this._parentElement.clientWidth)}_getRawSliderValue(e){if(!this._calculator)throw new Error("No calculator to calculate boundaries");const t=this._calculator.minimumBoundary(),i=this._calculator.maximumBoundary()-t;return e?t+i*(this.windowLeft||0):t+i*(this.windowRight||0)}_updateResizeElementPositionValue(e,t){const i=e.toFixed(2),s=t.toFixed(2);c.setAriaValueNow(this._leftResizeElement,i),c.setAriaValueNow(this._rightResizeElement,s);const r=Number(s)-.5,n=Number(i)+.5;c.setAriaValueMinMax(this._leftResizeElement,"0",r.toString()),c.setAriaValueMinMax(this._rightResizeElement,n.toString(),"100")}_updateResizeElementPositionLabels(){if(!this._calculator)return;const e=this._calculator.formatValue(this._getRawSliderValue(!0)),t=this._calculator.formatValue(this._getRawSliderValue(!1));c.setAriaValueText(this._leftResizeElement,String(e)),c.setAriaValueText(this._rightResizeElement,String(t))}_updateResizeElementPercentageLabels(e,t){c.setAriaValueText(this._leftResizeElement,e),c.setAriaValueText(this._rightResizeElement,t)}_calculateWindowPosition(){return{rawStartValue:Number(this._getRawSliderValue(!0)),rawEndValue:Number(this._getRawSliderValue(!1))}}_setWindow(e,t){let i;this.windowLeft=e,this.windowRight=t,this._updateCurtains(),this._calculator&&(i=this._calculateWindowPosition()),this.dispatchEventToListeners(ae.WindowChanged,i)}_updateCurtains(){const e=this.windowLeft||0,t=this.windowRight||0;let i=e,s=t;const r=s-i;if(0!==this._parentElement.clientWidth){const n=r*this._parentElement.clientWidth,o=7;if(n<o){const a=o/n;i=(t+e-r*a)/2,s=(t+e+r*a)/2}}const n=100*i,o=100*s,a=100-100*s,l=n+"%",h=o+"%";this._leftResizeElement.style.left=l,this._rightResizeElement.style.left=h,this._leftCurtainElement.style.width=l,this._rightCurtainElement.style.width=a+"%",this._updateResizeElementPositionValue(n,o),this._calculator?this._updateResizeElementPositionLabels():this._updateResizeElementPercentageLabels(l,h)}_setWindowPosition(e,t){const i=this._parentElement.clientWidth,s="number"==typeof e?e/i:this.windowLeft,r="number"==typeof t?t/i:this.windowRight;this._setWindow(s||0,r||0)}_onMouseWheel(e){const t=e;if(this._enabled){if(t.deltaY){const e=1.1,i=1/53,s=t.offsetX/this._parentElement.clientWidth;this._zoom(Math.pow(e,t.deltaY*i),s)}if(t.deltaX){let e=Math.round(.3*t.deltaX);const i=this._leftResizeElement.offsetLeft+3.5,s=this._rightResizeElement.offsetLeft+3.5;i-e<0&&(e=i),s-e>this._parentElement.clientWidth&&(e=s-this._parentElement.clientWidth),this._setWindowPosition(i-e,s-e),t.preventDefault()}}}_zoom(e,t){let i=this.windowLeft||0,s=this.windowRight||0;const r=s-i;let n=e*r;n>1&&(n=1,e=n/r),i=t+(i-t)*e,i=l.clamp(i,0,1-n),s=t+(s-t)*e,s=l.clamp(s,n,1),this._setWindow(i,s)}}const ae={WindowChanged:Symbol("WindowChanged")};class le{constructor(e,t){this._startPosition=t,this._width=e.offsetWidth,this._windowSelector=document.createElement("div"),this._windowSelector.className="overview-grid-window-selector",this._windowSelector.style.left=this._startPosition+"px",this._windowSelector.style.right=this._width-this._startPosition+"px",e.appendChild(this._windowSelector)}_close(e){return e=Math.max(0,Math.min(e,this._width)),this._windowSelector.remove(),this._startPosition<e?{start:this._startPosition,end:e}:{start:e,end:this._startPosition}}_updatePosition(e){(e=Math.max(0,Math.min(e,this._width)))<this._startPosition?(this._windowSelector.style.left=e+"px",this._windowSelector.style.right=this._width-this._startPosition+"px"):(this._windowSelector.style.left=this._startPosition+"px",this._windowSelector.style.right=this._width-e+"px")}}var he=Object.freeze({__proto__:null,OverviewGrid:ne,MinSelectableSize:14,WindowScrollSpeedFactor:.3,ResizerOffset:3.5,OffsetFromWindowEnds:10,Window:oe,Events:ae,WindowSelector:le});const de=n,{render:ce,html:_e,svg:me}=D;class ue extends HTMLElement{constructor(){super(...arguments),this.shadow=this.attachShadow({mode:"open"}),this.chartName="",this.size=0,this.formatter=e=>String(e),this.showLegend=!1,this.total=0,this.slices=[],this.totalSelected=!0,this.sliceSelected=-1,this.innerR=.618,this.lastAngle=-Math.PI/2}set data(e){this.chartName=e.chartName,this.size=e.size,this.formatter=e.formatter,this.showLegend=e.showLegend,this.total=e.total,this.slices=e.slices,this.render()}render(){this.lastAngle=-Math.PI/2;const e=_e`
      <style>
        .root {
          align-items: center;
          display: flex;
          min-width: fit-content;
          white-space: nowrap;
        }

        .chart-root {
          position: relative;
          overflow: hidden;
        }

        .pie-chart-foreground {
          position: absolute;
          width: 100%;
          height: 100%;
          z-index: 10;
          top: 0;
          display: flex;
          pointer-events: none;
        }

        .pie-chart-total {
          margin: auto;
          padding: 2px 5px;
          pointer-events: auto;
        }

        :focus {
          outline-width: 0;
        }

        .pie-chart-total.selected {
          font-weight: bold;
        }

        .chart-root .slice.selected {
          stroke: var(--selection-bg-color);
          stroke-opacity: 1;
          stroke-width: 0.04;
          stroke-linecap: round;
          stroke-linejoin: round;
        }

        .pie-chart-legend {
          margin-left: 30px;
        }

        .pie-chart-legend-row {
          margin: 5px 2px 5px auto;
          padding-right: 25px;
        }

        .pie-chart-legend-row.selected {
          font-weight: bold;
        }

        .pie-chart-legend-row:focus-visible {
          box-shadow: 0 0 0 2px var(--selection-bg-color) !important;
        }

        .pie-chart-swatch {
          display: inline-block;
          width: 11px;
          height: 11px;
          margin: 0 6px;
          top: 1px;
          position: relative;
          border: 1px solid rgb(100 100 100 / 20%);
        }

        .pie-chart-swatch.pie-chart-empty-swatch {
          border: none;
        }

        .pie-chart-name {
          display: inline-block;
        }

        .pie-chart-size {
          display: inline-block;
          text-align: right;
          width: 70px;
        }

        @media (forced-colors: active) {
          .pie-chart-swatch {
            forced-color-adjust: none;
            border-color: ButtonText;
          }

          .pie-chart-total {
            forced-color-adjust: none;
            background-color: canvas;
          }
        }
      </style>
      <div class="root" role="group" @keydown=${this.onKeyDown} aria-label=${this.chartName}>
        <div class="chart-root" style="width: ${this.size}px; height: ${this.size}px;">
          ${me`
          <svg>
          <g transform="scale(${this.size/2}) translate(1, 1) scale(0.99, 0.99)">
            <circle r="1" stroke="hsl(0, 0%, 80%)" fill="transparent" stroke-width=${1/this.size}></circle>
            <circle r=${this.innerR} stroke="hsl(0, 0%, 80%)" fill="transparent" stroke-width=${1/this.size}></circle>
            ${this.slices.map(((e,t)=>{const i=this.sliceSelected===t,s=i&&!this.showLegend?"0":"-1";return me`<path class="slice ${i?"selected":""}"
                  @click=${this.onSliceClicked(t)} tabIndex=${s}
                  fill=${e.color} d=${this.getPathStringForSlice(e)}
                  aria-label=${e.title} id=${i?"selectedSlice":""}></path>`}))}
            <!-- This is so that the selected slice is re-drawn on top, to avoid re-ordering slices
            just to render them properly. -->
            <use href="#selectedSlice" />
            </g>
          </svg>
          `}
          <div class="pie-chart-foreground">
            <div class="pie-chart-total ${this.totalSelected?"selected":""}" @click=${this.selectTotal}
                tabIndex=${this.totalSelected&&!this.showLegend?"1":"-1"}>
              ${this.total?this.formatter(this.total):""}
            </div>
          </div>
        </div>
        ${this.showLegend?_e`
        <div class="pie-chart-legend">
          ${this.slices.map(((e,t)=>{const i=this.sliceSelected===t;return _e`
              <div class="pie-chart-legend-row ${i?"selected":""}"
                  @click=${this.onSliceClicked(t)} tabIndex=${i?"0":"-1"}>
                <div class="pie-chart-size">${this.formatter(e.value)}</div>
                <div class="pie-chart-swatch" style="background-color: ${e.color};"></div>
                <div class="pie-chart-name">${e.title}</div>
              </div>`}))}
          <div class="pie-chart-legend-row ${this.totalSelected?"selected":""}"
              @click=${this.selectTotal} tabIndex=${this.totalSelected?"0":"-1"}>
            <div class="pie-chart-size">${this.formatter(this.total)}</div>
            <div class="pie-chart-swatch pie-chart-empty-swatch"></div>
            <div class="pie-chart-name">${de`Total`}</div>
          </div>
        </div>
        `:""}
    `;ce(e,this.shadow,{eventContext:this})}onSliceClicked(e){return()=>{this.selectSlice(e)}}selectSlice(e){this.totalSelected=!1,this.sliceSelected=e,this.render()}selectTotal(){this.totalSelected=!0,this.sliceSelected=-1,this.render()}selectAndFocusTotal(){this.selectTotal();const e=this.shadow.querySelector(".pie-chart-legend > :last-child");e&&e.focus()}selectAndFocusSlice(e){this.selectSlice(e);const t=this.shadow.querySelector(`.pie-chart-legend > :nth-child(${e+1})`);t&&t.focus()}focusNextElement(){this.totalSelected?this.selectAndFocusSlice(0):this.sliceSelected===this.slices.length-1?this.selectAndFocusTotal():this.selectAndFocusSlice(this.sliceSelected+1)}focusPreviousElement(){this.totalSelected?this.selectAndFocusSlice(this.slices.length-1):0===this.sliceSelected?this.selectAndFocusTotal():this.selectAndFocusSlice(this.sliceSelected-1)}onKeyDown(e){let t=!1;"ArrowDown"===e.key?(this.focusNextElement(),t=!0):"ArrowUp"===e.key&&(this.focusPreviousElement(),t=!0),t&&(e.stopImmediatePropagation(),e.preventDefault())}getPathStringForSlice(e){let t=e.value/this.total*2*Math.PI;if(!isFinite(t))return;t=Math.min(t,2*Math.PI*.9999);const i=Math.cos(this.lastAngle),s=Math.sin(this.lastAngle);this.lastAngle+=t;const r=Math.cos(this.lastAngle),n=Math.sin(this.lastAngle),o=this.innerR,a=r*o,l=n*o,h=i*o,d=s*o,c=t>Math.PI?1:0;return`M${i},${s} A1,1,0,${c},1,${r},${n} L${a},${l} A${o},${o},0,${c},0,${h},${d} Z`}}customElements.get("devtools-perf-piechart")||customElements.define("devtools-perf-piechart",ue);var ge=Object.freeze({__proto__:null,PieChart:ue});class fe extends d.VBox{constructor(e){super(),this.element.id=e+"-overview-pane",this._overviewCalculator=new ve,this._overviewGrid=new ne(e,this._overviewCalculator),this.element.appendChild(this._overviewGrid.element),this._cursorArea=this._overviewGrid.element.createChild("div","overview-grid-cursor-area"),this._cursorElement=this._overviewGrid.element.createChild("div","overview-grid-cursor-position"),this._cursorArea.addEventListener("mousemove",this._onMouseMove.bind(this),!0),this._cursorArea.addEventListener("mouseleave",this._hideCursor.bind(this),!0),this._overviewGrid.setResizeEnabled(!1),this._overviewGrid.addEventListener(ae.WindowChanged,this._onWindowChanged,this),this._overviewGrid.setClickHandler(this._onClick.bind(this)),this._overviewControls=[],this._markers=new Map,this._overviewInfo=new ye(this._cursorElement),this._updateThrottler=new o.Throttler(100),this._cursorEnabled=!1,this._cursorPosition=0,this._lastWidth=0,this._windowStartTime=0,this._windowEndTime=1/0,this._muteOnWindowChanged=!1}_onMouseMove(e){if(!this._cursorEnabled)return;const t=e,i=e.target;this._cursorPosition=t.offsetX+i.offsetLeft,this._cursorElement.style.left=this._cursorPosition+"px",this._cursorElement.style.visibility="visible",this._overviewInfo.setContent(this._buildOverviewInfo())}async _buildOverviewInfo(){const e=this.element.ownerDocument,t=this._cursorPosition,i=await Promise.all(this._overviewControls.map((e=>e.overviewInfoPromise(t)))),s=e.createDocumentFragment(),r=i.filter((e=>null!==e));return s.append(...r),s}_hideCursor(){this._cursorElement.style.visibility="hidden",this._overviewInfo.hide()}wasShown(){this._update()}willHide(){this._overviewInfo.hide()}onResize(){const e=this.element.offsetWidth;e!==this._lastWidth&&(this._lastWidth=e,this.scheduleUpdate())}setOverviewControls(e){for(let e=0;e<this._overviewControls.length;++e)this._overviewControls[e].dispose();for(let t=0;t<e.length;++t)e[t].setCalculator(this._overviewCalculator),e[t].show(this._overviewGrid.element);this._overviewControls=e,this._update()}setBounds(e,t){this._overviewCalculator.setBounds(e,t),this._overviewGrid.setResizeEnabled(!0),this._cursorEnabled=!0}setNavStartTimes(e){this._overviewCalculator.setNavStartTimes(e)}scheduleUpdate(){this._updateThrottler.schedule((async()=>{this._update()}))}_update(){if(this.isShowing()){this._overviewCalculator.setDisplayWidth(this._overviewGrid.clientWidth());for(let e=0;e<this._overviewControls.length;++e)this._overviewControls[e].update();this._overviewGrid.updateDividers(this._overviewCalculator),this._updateMarkers(),this._updateWindow()}}setMarkers(e){this._markers=e}_updateMarkers(){const e=new Map;for(const t of this._markers.keys()){const i=this._markers.get(t),s=Math.round(this._overviewCalculator.computePosition(t));e.has(s)||(e.set(s,i),i.style.left=s+"px")}this._overviewGrid.removeEventDividers(),this._overviewGrid.addEventDividers([...e.values()])}reset(){this._windowStartTime=0,this._windowEndTime=1/0,this._overviewCalculator.reset(),this._overviewGrid.reset(),this._overviewGrid.setResizeEnabled(!1),this._cursorEnabled=!1,this._hideCursor(),this._markers=new Map;for(const e of this._overviewControls)e.reset();this._overviewInfo.hide(),this.scheduleUpdate()}_onClick(e){return this._overviewControls.some((t=>t.onClick(e)))}_onWindowChanged(e){if(this._muteOnWindowChanged)return;if(!this._overviewControls.length)return;this._windowStartTime=e.data.rawStartValue,this._windowEndTime=e.data.rawEndValue;const t={startTime:this._windowStartTime,endTime:this._windowEndTime};this.dispatchEventToListeners(pe.WindowChanged,t)}setWindowTimes(e,t){e===this._windowStartTime&&t===this._windowEndTime||(this._windowStartTime=e,this._windowEndTime=t,this._updateWindow(),this.dispatchEventToListeners(pe.WindowChanged,{startTime:e,endTime:t}))}_updateWindow(){if(!this._overviewControls.length)return;const e=this._overviewCalculator.minimumBoundary(),t=this._overviewCalculator.maximumBoundary()-e,i=e>0,s=i&&this._windowStartTime?Math.min((this._windowStartTime-e)/t,1):0,r=i&&this._windowEndTime<1/0?(this._windowEndTime-e)/t:1;this._muteOnWindowChanged=!0,this._overviewGrid.setWindow(s,r),this._muteOnWindowChanged=!1}}const pe={WindowChanged:Symbol("WindowChanged")};class ve{constructor(){this.reset(),this._minimumBoundary,this._maximumBoundary,this._workingArea}computePosition(e){return(e-this._minimumBoundary)/this.boundarySpan()*this._workingArea}positionToTime(e){return e/this._workingArea*this.boundarySpan()+this._minimumBoundary}setBounds(e,t){this._minimumBoundary=e,this._maximumBoundary=t}setNavStartTimes(e){this._navStartTimes=e}setDisplayWidth(e){this._workingArea=e}reset(){this.setBounds(0,100)}formatValue(e,t){if(this._navStartTimes){const t=Array.from(this._navStartTimes.values());for(let i=t.length-1;i>=0;i--)if(e>t[i].startTime){e-=t[i].startTime-this.zeroTime();break}}return Number.preciseMillisToString(e-this.zeroTime(),t)}maximumBoundary(){return this._maximumBoundary}minimumBoundary(){return this._minimumBoundary}zeroTime(){return this._minimumBoundary}boundarySpan(){return this._maximumBoundary-this._minimumBoundary}}class we extends d.VBox{constructor(){super(),this._calculator=null,this._canvas=this.element.createChild("canvas","fill"),this._context=this._canvas.getContext("2d")}width(){return this._canvas.width}height(){return this._canvas.height}context(){if(!this._context)throw new Error("Unable to retrieve canvas context");return this._context}calculator(){return this._calculator}update(){this.resetCanvas()}dispose(){this.detach()}reset(){}overviewInfoPromise(e){return Promise.resolve(null)}setCalculator(e){this._calculator=e}onClick(e){return!1}resetCanvas(){this.element.clientWidth&&this.setCanvasSize(this.element.clientWidth,this.element.clientHeight)}setCanvasSize(e,t){this._canvas.width=e*window.devicePixelRatio,this._canvas.height=t*window.devicePixelRatio}}class ye{constructor(e){this._anchorElement=e,this._glassPane=new p.GlassPane,this._glassPane.setPointerEventsBehavior(p.PointerEventsBehavior.PierceContents),this._glassPane.setMarginBehavior(p.MarginBehavior.Arrow),this._glassPane.setSizeBehavior(p.SizeBehavior.MeasureContent),this._visible=!1,this._element=h.createShadowRootWithCoreStyles(this._glassPane.contentElement,{cssFile:"perf_ui/timelineOverviewInfo.css",enableLegacyPatching:!1,delegatesFocus:void 0}).createChild("div","overview-info")}async setContent(e){this._visible=!0;const t=await e;this._visible&&(this._element.removeChildren(),this._element.appendChild(t),this._glassPane.setContentAnchorBox(this._anchorElement.boxInWindow()),this._glassPane.isShowing()||this._glassPane.show(this._anchorElement.ownerDocument))}hide(){this._visible=!1,this._glassPane.hide()}}var Ee=Object.freeze({__proto__:null,TimelineOverviewPane:fe,Events:pe,TimelineOverviewCalculator:ve,TimelineOverview:class{show(e,t){}update(){}dispose(){}reset(){}overviewInfoPromise(e){throw new Error("Not implemented")}onClick(e){throw new Error("Not implemented")}setCalculator(e){}},TimelineOverviewBase:we,OverviewInfo:ye});export{V as ChartViewport,U as FilmStripView,W as FlameChart,X as GCActionDelegate,J as LineLevelProfile,Q as LiveHeapProfile,re as NetworkPriorities,he as OverviewGrid,ge as PieChart,G as TimelineGrid,Ee as TimelineOverviewPane};
