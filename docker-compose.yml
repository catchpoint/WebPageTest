---
version: '3.6'
# READ THE DOCKER/LOCAL/README FOR MORE INFORMATION
services:
  web_debug:
    profiles: ["web_debug", "all_debug"]
    build: 
      context: .
      dockerfile: Dockerfile
      target: debug
    extra_hosts: # Needed for xdebug
      - "host.docker.internal:host-gateway"
    ports:
      - "80:80"
      - "9000:9000"
    volumes:
      - ./docker/local/server/xdebug/xdebug.ini:/usr/local/etc/php/conf.d/docker-php-ext-xdebug.ini
      - ./docker/local/server/xdebug/error_reporting.ini:/usr/local/etc/php/conf.d/error_reporting.ini
      - ./data/results:/var/www/webpagetest/www/results
      - ./data:/data
      - ./www:/var/www/webpagetest/www
    secrets:
      - source: wpt_devices_ini
        target: /var/www/webpagetest/www/settings/mobile_devices.ini
      - source: wpt_profiles_ini
        target: /var/www/webpagetest/www/settings/profiles.ini
      - source: wpt_settings_ini
        target: /var/www/webpagetest/www/settings/settings.ini
      - source: wpt_keys_ini
        target: /var/www/webpagetest/www/settings/keys.ini
      - source: wpt_locations_ini
        target: /var/www/webpagetest/www/settings/locations.ini
    networks:
      wpt_net:
        aliases:
          - wpt

  web:
    profiles: ["web", "all", "agent_debug"]
    build: 
      context: .
      dockerfile: Dockerfile
      target: production
    ports:
      - "80:80"
    volumes:
      - ./docker/local/server/xdebug/xdebug.ini:/usr/local/etc/php/conf.d/docker-php-ext-xdebug.ini
      - ./docker/local/server/xdebug/error_reporting.ini:/usr/local/etc/php/conf.d/error_reporting.ini
      - ./data/results:/var/www/webpagetest/www/results
      - ./data:/data
      - ./www:/var/www/webpagetest/www
    secrets:
      - source: wpt_devices_ini
        target: /var/www/webpagetest/www/settings/mobile_devices.ini
      - source: wpt_profiles_ini
        target: /var/www/webpagetest/www/settings/profiles.ini
      - source: wpt_settings_ini
        target: /var/www/webpagetest/www/settings/settings.ini
      - source: wpt_keys_ini
        target: /var/www/webpagetest/www/settings/keys.ini
      - source: wpt_locations_ini
        target: /var/www/webpagetest/www/settings/locations.ini
    networks:
      wpt_net:
        aliases:
          - wpt

  agent_debug:
    profiles: ["agent_debug", "all_debug"]
    build:
      context: https://github.com/FedericoMulas/wptagent.git
      target: debug
    environment:
      - SERVER_URL=http://wpt:80/work/
      - LOCATION=Scheduler
      - KEY=12345-54321
    init: true
    cap_add:
      - NET_ADMIN
    ports:
      - "50000:50000"
    networks:
      - wpt_net

  agent:
    profiles: ["all", "web_debug"]
    build:
      context: https://github.com/FedericoMulas/wptagent.git
      target: production
    environment:
      - SERVER_URL=http://wpt:80/work/
      - LOCATION=Scheduler
      - KEY=12345-54321
    init: true
    cap_add:
      - NET_ADMIN
    extra_hosts:
      - "frontend:"
    networks:
      - wpt_net

secrets:
  wpt_devices_ini:
    file: ./docker/local/server/config/mobile_devices.ini
  wpt_profiles_ini:
    file: ./docker/local/wptconfig/profiles.ini
  wpt_settings_ini:
    file: ./docker/local/wptconfig/settings.ini
  wpt_keys_ini:
    file: ./docker/local/wptconfig/keys.ini
  wpt_locations_ini:
    file: ./docker/local/wptconfig/locations.ini

networks:
  wpt_net:
    name: wpt_net
    driver: bridge
